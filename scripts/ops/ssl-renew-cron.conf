# Let's Encrypt SSL Certificate Auto-Renewal Crontab
#
# Installation:
#   1. Copy this file to /etc/cron.d/agentiq-ssl-renew (requires sudo)
#   2. Ensure certbot is installed: sudo apt install certbot python3-certbot-nginx
#   3. Logs: /var/log/letsencrypt/letsencrypt.log
#
# Notes:
#   - Let's Encrypt recommends running renewal twice daily
#   - certbot renew is idempotent (only renews if cert expires within 30 days)
#   - nginx reload is only triggered if renewal actually happens
#   - SSL check runs daily at 6 AM to monitor cert health

SHELL=/bin/bash
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=admin@agentiq.ru

# Auto-renew SSL certificate (twice daily, Let's Encrypt best practice)
# Runs at 3:15 AM and 3:15 PM
15 3,15 * * * root certbot renew --quiet --post-hook "systemctl reload nginx"

# Check SSL certificate expiration daily at 6 AM
# Alerts if < 14 days until expiry
0 6 * * * root /opt/agentiq/scripts/ops/ssl-check.sh agentiq.ru 14 || echo "SSL check failed or cert expiring soon"

# Weekly full check with verbose output (Mondays at 7 AM)
# Useful for debugging renewal issues
0 7 * * 1 root certbot renew --dry-run || echo "Certbot dry-run failed - check logs"
