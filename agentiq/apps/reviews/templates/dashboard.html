<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard - AgentIQ Reviews</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    font-family: 'Montserrat', sans-serif;
    background: #0f1923;
    color: #fff;
    -webkit-font-smoothing: antialiased;
  }

  /* Nav */
  nav {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 24px 48px;
    max-width: 1200px;
    margin: 0 auto;
    border-bottom: 1px solid rgba(255,255,255,0.08);
  }

  .logo {
    font-size: 18px;
    font-weight: 700;
    letter-spacing: 1px;
    color: #fff;
    text-decoration: none;
  }

  .logo span {
    color: #f06543;
  }

  .user-info {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .user-name {
    font-size: 14px;
    color: #8a9bb0;
  }

  .btn-logout {
    font-size: 13px;
    color: #8a9bb0;
    background: transparent;
    border: 1px solid rgba(255,255,255,0.12);
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-logout:hover {
    border-color: rgba(255,255,255,0.3);
    color: #fff;
  }

  /* Main */
  main {
    max-width: 1200px;
    margin: 0 auto;
    padding: 48px;
  }

  h1 {
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 32px;
  }

  /* New Task Form */
  .new-task-section {
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 16px;
    padding: 28px 32px;
    margin-bottom: 40px;
  }

  .form-label {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 12px;
    display: block;
    color: #fff;
  }

  .form-row {
    display: flex;
    gap: 12px;
  }

  .input-article {
    flex: 1;
    background: rgba(0,0,0,0.3);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 8px;
    padding: 12px 16px;
    font-size: 15px;
    color: #fff;
    font-family: 'Montserrat', sans-serif;
  }

  .input-article:focus {
    outline: none;
    border-color: #f06543;
  }

  .btn-primary {
    background: #f06543;
    color: #fff;
    font-size: 15px;
    font-weight: 600;
    padding: 12px 28px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: background 0.2s;
    font-family: 'Montserrat', sans-serif;
  }

  .btn-primary:hover {
    background: #d9533f;
  }

  .btn-primary:disabled {
    background: rgba(240, 101, 67, 0.4);
    cursor: not-allowed;
  }

  .form-note {
    font-size: 12px;
    color: #5c7080;
    margin-top: 8px;
  }

  /* Tasks List */
  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
  }

  .section-title {
    font-size: 18px;
    font-weight: 600;
    color: #fff;
  }

  .task-count {
    font-size: 14px;
    color: #8a9bb0;
  }

  .tasks-list {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .task-card {
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 12px;
    padding: 20px 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: border-color 0.2s, background 0.2s;
  }

  .task-card:hover {
    border-color: rgba(255,255,255,0.15);
    background: rgba(255,255,255,0.06);
  }

  .task-info {
    flex: 1;
  }

  .task-status-badge {
    display: inline-flex;
    align-items: center;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    padding: 4px 10px;
    border-radius: 20px;
    margin-bottom: 8px;
  }

  .task-status-badge.warning {
    color: #f06543;
    background: rgba(240, 101, 67, 0.15);
  }

  .task-status-badge.success {
    color: #4caf7a;
    background: rgba(76, 175, 122, 0.15);
  }

  .task-status-badge.processing {
    color: #7db8e8;
    background: rgba(125, 184, 232, 0.15);
  }

  .task-status-badge.failed {
    color: #e74c3c;
    background: rgba(231, 76, 60, 0.15);
  }

  .task-title {
    font-size: 16px;
    font-weight: 600;
    color: #fff;
    margin-bottom: 4px;
  }

  .task-meta {
    font-size: 13px;
    color: #8a9bb0;
  }

  .quality-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-left: 6px;
    vertical-align: middle;
  }

  .quality-indicator.good {
    background: #4ecb71;
    box-shadow: 0 0 6px rgba(78, 203, 113, 0.5);
  }

  .quality-indicator.medium {
    background: #e8a838;
    box-shadow: 0 0 6px rgba(232, 168, 56, 0.5);
  }

  .quality-indicator.bad {
    background: #e85454;
    box-shadow: 0 0 6px rgba(232, 84, 84, 0.5);
  }

  .progress-bar-container {
    width: 100%;
    height: 6px;
    background: rgba(255,255,255,0.08);
    border-radius: 3px;
    margin-top: 12px;
    overflow: hidden;
  }

  .progress-bar {
    height: 100%;
    background: #7db8e8;
    border-radius: 3px;
    transition: width 0.3s;
  }

  .task-actions {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .btn-secondary {
    background: transparent;
    border: 1px solid rgba(255,255,255,0.15);
    color: #fff;
    font-size: 13px;
    font-weight: 500;
    padding: 9px 16px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    font-family: 'Montserrat', sans-serif;
    white-space: nowrap;
  }

  .btn-secondary:hover {
    border-color: rgba(255,255,255,0.3);
    background: rgba(255,255,255,0.04);
  }

  .btn-secondary.comm {
    border-color: rgba(232, 168, 56, 0.3);
    color: #e8a838;
  }

  .btn-secondary.comm:hover {
    border-color: rgba(232, 168, 56, 0.5);
    background: rgba(232, 168, 56, 0.06);
  }

  .btn-delete {
    background: transparent;
    border: none;
    color: #5c7080;
    font-size: 16px;
    cursor: pointer;
    padding: 6px 8px;
    border-radius: 6px;
    transition: all 0.2s;
    line-height: 1;
  }

  .btn-delete:hover {
    color: #e74c3c;
    background: rgba(231, 76, 60, 0.1);
  }

  .confirm-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.6);
    z-index: 100;
    justify-content: center;
    align-items: center;
  }

  .confirm-overlay.active { display: flex; }

  .confirm-dialog {
    background: #1a2636;
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 12px;
    padding: 24px;
    max-width: 360px;
    width: 90%;
    text-align: center;
  }

  .confirm-dialog h3 {
    font-size: 16px;
    margin-bottom: 8px;
  }

  .confirm-dialog p {
    font-size: 13px;
    color: #8a9bb0;
    margin-bottom: 20px;
  }

  .confirm-actions {
    display: flex;
    gap: 12px;
    justify-content: center;
  }

  .confirm-actions button {
    font-family: 'Montserrat', sans-serif;
    font-size: 14px;
    font-weight: 500;
    padding: 10px 24px;
    border-radius: 8px;
    cursor: pointer;
    border: none;
  }

  .btn-cancel {
    background: rgba(255,255,255,0.08);
    color: #8a9bb0;
  }

  .btn-cancel:hover { background: rgba(255,255,255,0.12); }

  .btn-danger {
    background: #e74c3c;
    color: #fff;
  }

  .btn-danger:hover { background: #c0392b; }

  .empty-state {
    text-align: center;
    padding: 60px 24px;
    color: #5c7080;
  }

  .empty-state-icon {
    font-size: 48px;
    margin-bottom: 16px;
  }

  .empty-state-text {
    font-size: 15px;
  }

  @media (max-width: 768px) {
    nav, main {
      padding: 20px 24px;
    }

    .task-card {
      flex-direction: column;
      align-items: flex-start;
      gap: 16px;
    }

    .task-actions {
      width: 100%;
      flex-wrap: wrap;
    }

    .btn-secondary {
      flex: 1;
      text-align: center;
      min-width: 120px;
    }
  }
</style>
</head>
<body>

<nav>
  <a href="/" class="logo">AGENT<span>IQ</span></a>
  <div class="user-info">
    <span class="user-name">{{ user.first_name or user.username or 'User' }}</span>
    <button class="btn-logout" onclick="logout()">–í—ã–π—Ç–∏</button>
  </div>
</nav>

<main>
  <h1>–ê–Ω–∞–ª–∏–∑ –æ—Ç–∑—ã–≤–æ–≤ WB</h1>

  <!-- New Task Form -->
  <section class="new-task-section">
    <label class="form-label" for="article-input">–ù–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑</label>
    <div class="form-row">
      <input
        type="number"
        id="article-input"
        class="input-article"
        placeholder="–í–≤–µ–¥–∏—Ç–µ –∞—Ä—Ç–∏–∫—É–ª WB"
        min="1"
      >
      <button class="btn-primary" onclick="createTask()">–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>
    <div class="form-note" id="form-note">
      –í–≤–µ–¥–∏—Ç–µ –∞—Ä—Ç–∏–∫—É–ª —Ç–æ–≤–∞—Ä–∞ —Å Wildberries (–Ω–∞–ø—Ä–∏–º–µ—Ä: 117220345)
    </div>
  </section>

  <!-- Tasks List -->
  <section class="section-header">
    <h2 class="section-title">–í–∞—à–∏ –æ—Ç—á—ë—Ç—ã</h2>
    <span class="task-count" id="task-count">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
  </section>

  <div class="tasks-list" id="tasks-list">
    <div class="empty-state">
      <div class="empty-state-icon">üìä</div>
      <div class="empty-state-text">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á—ë—Ç–æ–≤...</div>
    </div>
  </div>
</main>

<!-- Delete confirmation dialog -->
<div class="confirm-overlay" id="confirm-overlay">
  <div class="confirm-dialog">
    <h3>–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?</h3>
    <p id="confirm-text">–ó–∞–¥–∞—á–∞ –∏ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç—á—ë—Ç–∞ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.</p>
    <div class="confirm-actions">
      <button class="btn-cancel" onclick="closeConfirm()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn-danger" id="confirm-delete-btn" onclick="confirmDelete()">–£–¥–∞–ª–∏—Ç—å</button>
    </div>
  </div>
</div>

<script>
let tasksData = [];
let pollingInterval = null;

async function createTask() {
  const input = document.getElementById('article-input');
  const articleId = parseInt(input.value);

  if (!articleId || articleId < 1) {
    showNote('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∞—Ä—Ç–∏–∫—É–ª', 'error');
    return;
  }

  const btn = event.target;
  btn.disabled = true;
  btn.textContent = '–°–æ–∑–¥–∞—ë–º...';

  try {
    const response = await fetch('/api/tasks/create', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ article_id: articleId }),
    });

    if (!response.ok) {
      throw new Error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏');
    }

    const task = await response.json();
    showNote('–ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞! –ü–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram, –∫–æ–≥–¥–∞ –∞–Ω–∞–ª–∏–∑ –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤.', 'success');
    input.value = '';

    // Refresh task list
    await loadTasks();

    // Start polling if not already running
    if (!pollingInterval) {
      startPolling();
    }

  } catch (error) {
    showNote('–û—à–∏–±–∫–∞: ' + error.message, 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = '–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å';
  }
}

async function loadTasks() {
  try {
    const response = await fetch('/api/tasks/list');
    if (!response.ok) {
      if (response.status === 401) {
        window.location.href = '/';
        return;
      }
      throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á');
    }

    tasksData = await response.json();
    renderTasks();
  } catch (error) {
    console.error('Failed to load tasks:', error);
  }
}

function renderTasks() {
  const listElement = document.getElementById('tasks-list');
  const countElement = document.getElementById('task-count');

  countElement.textContent = `${tasksData.length} ${pluralize(tasksData.length, '–æ—Ç—á—ë—Ç', '–æ—Ç—á—ë—Ç–∞', '–æ—Ç—á—ë—Ç–æ–≤')}`;

  if (tasksData.length === 0) {
    listElement.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üìä</div>
        <div class="empty-state-text">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç—á—ë—Ç–æ–≤. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –∞–Ω–∞–ª–∏–∑ –≤—ã—à–µ.</div>
      </div>
    `;
    return;
  }

  listElement.innerHTML = tasksData.map(task => {
    const statusConfig = getStatusConfig(task.status);
    const timeAgo = formatTimeAgo(task.created_at);

    return `
      <div class="task-card">
        <div class="task-info">
          <span class="task-status-badge ${statusConfig.class}">${statusConfig.icon} ${statusConfig.label}</span>
          <div class="task-title">${task.product_name ? task.product_name + ' (' + task.article_id + ')' : '–ê—Ä—Ç–∏–∫—É–ª ' + task.article_id}</div>
          <div class="task-meta">
            ${timeAgo}${task.status === 'completed' && (task.rating || task.feedback_count) ? `
            <span class="task-snippet"> ¬∑ ‚òÖ${task.rating ? task.rating.toFixed(1) : '‚Äî'}${task.feedback_count ? ' ¬∑ ' + task.feedback_count + ' –æ—Ç–∑.' : ''}${task.quality_score ? ' ¬∑ –æ—Ç–≤–µ—Ç—ã ' + task.quality_score + '/10' : ''}</span>${task.quality_score ? getQualityIndicator(task.quality_score) : ''}` : ''}
          </div>
          ${task.status === 'processing' ? `
            <div class="progress-bar-container">
              <div class="progress-bar" style="width: ${task.progress}%"></div>
            </div>
            <div class="task-meta" style="margin-top: 6px; font-size: 12px; color: #5c7080;">${estimateTime(task)}</div>
          ` : ''}
          ${task.status === 'failed' ? `
            <div class="task-meta" style="color: #e74c3c; margin-top: 8px;">–û—à–∏–±–∫–∞: ${task.error_message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</div>
          ` : ''}
        </div>
        <div class="task-actions">
          ${task.status === 'completed' ? `
            <a href="/dashboard/report/${task.id}" class="btn-secondary">–ê–Ω–∞–ª–∏–∑ —Ç–æ–≤–∞—Ä–∞</a>
            <a href="/dashboard/report/${task.id}/communication" class="btn-secondary comm">–ê–Ω–∞–ª–∏–∑ –æ—Ç–≤–µ—Ç–æ–≤</a>
            <button class="btn-delete" onclick="showDeleteConfirm(${task.id}, ${task.article_id})" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
          ` : task.status === 'processing' ? `
            <button class="btn-secondary" disabled>–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è... ${task.progress}%</button>
          ` : task.status === 'failed' ? `
            <button class="btn-secondary" onclick="retryTask(${task.id})">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
            <button class="btn-delete" onclick="showDeleteConfirm(${task.id}, ${task.article_id})" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
          ` : ''}
        </div>
      </div>
    `;
  }).join('');
}

function getStatusConfig(status) {
  const configs = {
    'pending': { icon: '‚è≥', label: '–í –æ—á–µ—Ä–µ–¥–∏', class: 'processing' },
    'processing': { icon: 'üîÑ', label: '–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è', class: 'processing' },
    'completed': { icon: '‚úì', label: '–ì–æ—Ç–æ–≤', class: 'success' },
    'failed': { icon: '‚úó', label: '–û—à–∏–±–∫–∞', class: 'failed' },
  };
  return configs[status] || configs['pending'];
}

function formatTimeAgo(dateString) {
  // Server returns UTC without 'Z' suffix ‚Äî append it so JS interprets correctly
  const date = new Date(dateString.endsWith('Z') ? dateString : dateString + 'Z');
  const now = new Date();
  const diff = Math.floor((now - date) / 1000); // seconds

  if (diff < 60) return '–¢–æ–ª—å–∫–æ —á—Ç–æ';
  if (diff < 3600) return `${Math.floor(diff / 60)} –º–∏–Ω –Ω–∞–∑–∞–¥`;
  if (diff < 86400) return `${Math.floor(diff / 3600)} —á –Ω–∞–∑–∞–¥`;
  return `${Math.floor(diff / 86400)} –¥–Ω –Ω–∞–∑–∞–¥`;
}

function pluralize(num, one, two, five) {
  if (num % 10 === 1 && num % 100 !== 11) return one;
  if (num % 10 >= 2 && num % 10 <= 4 && (num % 100 < 10 || num % 100 >= 20)) return two;
  return five;
}

function estimateTime(task) {
  if (!task.created_at || task.progress <= 0) return '–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏...';
  const created = new Date(task.created_at.endsWith('Z') ? task.created_at : task.created_at + 'Z');
  const now = new Date();
  const elapsedSec = Math.floor((now - created) / 1000);
  if (elapsedSec < 5 || task.progress < 5) return '–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏...';
  const totalEstSec = Math.round(elapsedSec / (task.progress / 100));
  const remainSec = Math.max(0, totalEstSec - elapsedSec);
  if (remainSec < 30) return '–ü–æ—á—Ç–∏ –≥–æ—Ç–æ–≤–æ...';
  if (remainSec < 60) return '~–º–µ–Ω–µ–µ –º–∏–Ω—É—Ç—ã';
  const mins = Math.ceil(remainSec / 60);
  return `~${mins} ${pluralize(mins, '–º–∏–Ω—É—Ç–∞', '–º–∏–Ω—É—Ç—ã', '–º–∏–Ω—É—Ç')}`;
}

function getQualityIndicator(score) {
  if (!score) return '';
  let className = 'bad';
  if (score >= 7) className = 'good';
  else if (score >= 4) className = 'medium';
  return `<span class="quality-indicator ${className}"></span>`;
}

function showNote(message, type = 'info') {
  const noteElement = document.getElementById('form-note');
  noteElement.textContent = message;
  noteElement.style.color = type === 'error' ? '#e74c3c' : type === 'success' ? '#4caf7a' : '#5c7080';

  if (type !== 'info') {
    setTimeout(() => {
      noteElement.textContent = '–í–≤–µ–¥–∏—Ç–µ –∞—Ä—Ç–∏–∫—É–ª —Ç–æ–≤–∞—Ä–∞ —Å Wildberries (–Ω–∞–ø—Ä–∏–º–µ—Ä: 117220345)';
      noteElement.style.color = '#5c7080';
    }, 5000);
  }
}

async function logout() {
  try {
    await fetch('/api/auth/logout', { method: 'POST' });
    window.location.href = '/';
  } catch (error) {
    console.error('Logout failed:', error);
    window.location.href = '/';
  }
}

function startPolling() {
  pollingInterval = setInterval(async () => {
    // Check if any task is processing
    const hasProcessing = tasksData.some(t => t.status === 'processing' || t.status === 'pending');

    if (hasProcessing) {
      await loadTasks();
    } else {
      // Stop polling if no active tasks
      stopPolling();
    }
  }, 5000); // Poll every 5 seconds
}

function stopPolling() {
  if (pollingInterval) {
    clearInterval(pollingInterval);
    pollingInterval = null;
  }
}

// Delete task
let deleteTaskId = null;

function showDeleteConfirm(taskId, articleId) {
  deleteTaskId = taskId;
  document.getElementById('confirm-text').textContent = `–ó–∞–¥–∞—á–∞ –∞—Ä—Ç–∏–∫—É–ª–∞ ${articleId} –∏ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç—á—ë—Ç–∞ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.`;
  document.getElementById('confirm-overlay').classList.add('active');
}

function closeConfirm() {
  deleteTaskId = null;
  document.getElementById('confirm-overlay').classList.remove('active');
}

async function confirmDelete() {
  if (!deleteTaskId) return;
  const btn = document.getElementById('confirm-delete-btn');
  btn.disabled = true;
  btn.textContent = '–£–¥–∞–ª—è–µ–º...';

  try {
    const response = await fetch(`/api/tasks/${deleteTaskId}`, { method: 'DELETE' });
    if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
    closeConfirm();
    await loadTasks();
  } catch (error) {
    alert('–û—à–∏–±–∫–∞: ' + error.message);
  } finally {
    btn.disabled = false;
    btn.textContent = '–£–¥–∞–ª–∏—Ç—å';
  }
}

// Close confirm on overlay click
document.getElementById('confirm-overlay').addEventListener('click', function(e) {
  if (e.target === this) closeConfirm();
});

// Initial load
loadTasks();

// Start polling if there are active tasks
setTimeout(() => {
  const hasProcessing = tasksData.some(t => t.status === 'processing' || t.status === 'pending');
  if (hasProcessing) {
    startPolling();
  }
}, 1000);

// Stop polling when user leaves page
window.addEventListener('beforeunload', stopPolling);
</script>

</body>
</html>
