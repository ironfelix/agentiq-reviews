# Правила Reasoning'а для AgentIQ

## 1. Иерархия данных

### Что анализируем (по приоритету):
1. **disadvantages** — поле "минусы", точно негатив → анализируем всегда
2. **advantages** — поле "плюсы", но если rating ≤ 3 → люди пишут жалобы туда
3. **fb_text** — основной текст, только если не нашли в других полях

### Фильтрация позитива:
- Для `disadvantages` — **не фильтруем** (там уже негатив)
- Для `fb_text` — фильтруем по POSITIVE_HINTS ("хорош", "отлич", "класс"...)
- Исключение: если рейтинг ≤ 3, не фильтруем

---

## 2. Классификация причин

### Гибридная система:
```
REASONS = UNIVERSAL_REASONS + CATEGORY_PRESETS[category]
```

### Универсальные причины (все товары):
| Key | Label | Паттерны |
|-----|-------|----------|
| defect | Брак / дефект | брак, дефект, сломал, не работа |
| mismatch | Не соответствует описанию | описани, ожидал, на фото |
| delivery | Повреждение при доставке | доставк, помят, упаковк |

### Категорийные причины (по нишам):
- **flashlight**: brightness, battery, waterproof, build
- **clothing**: size, fabric, color_mismatch, smell
- **electronics**: battery, connectivity, sound
- **pet_food**: flavor_mismatch, pet_rejection, packaging, freshness, composition

### Автодетект категории:
```python
CATEGORY_KEYWORDS = {
    "flashlight": ["фонар", "налобн", "свет", "лампа", "прожектор"],
    "clothing": ["платье", "куртка", "брюки", "футболк", "одежд", "размер"],
    "electronics": ["наушник", "колонк", "зарядк", "кабель", "смартфон"],
    "pet_food": ["корм", "кошк", "собак", "питом", "животн"],
}
```
Если название товара содержит ключевое слово → выбираем категорию автоматически.

### Multi-label:
- Один отзыв → несколько причин
- "Светит хорошо, батарейки на 10 минут" → brightness + battery

---

## 3. Выделение вариантов

### Важно: вариант ≠ отдельный товар

На WB поле `color` может означать разное:
- **Цвет корпуса** — реально разные физические товары
- **Режим работы** — один товар, разные функции (фонарик: белый/красный/синий режим)
- **Комплектация** — "4 шт. · 120 м" vs "1 шт. · 200 м"

### Как понять что это:
| Значение color | Что это | Пример |
|----------------|---------|--------|
| "красный", "синий" | Режим свечения | Фонарик с разными спектрами |
| "4 шт. · 120 м" | Комплектация | Набор фонариков |
| "серый, зеленый" | Набор цветов | Комплект разных цветов |

### Что считается цветовым вариантом:
```python
COLOR_WORDS = ("красн", "син", "сер", "черн", "бел", "зел"...)
```

### Что НЕ вариант (исключаем):
```python
NON_COLOR_HINTS = ("шт", "м", "мм", "см", "л", "мл"...)
```

### Логика:
- Если название содержит цвет → это вариант (или режим!)
- Если содержит размер/количество → это НЕ вариант, группируем в "Один товар"

### Интерпретация для пользователя:
- Для фонариков: "режим свечения" (не "вариант товара")
- Для одежды: "цвет" (реально разные товары)
- Для наборов: "комплектация"

---

## 4. Временные окна

### Периоды:
- **recent**: последние 30 дней (WINDOW_DAYS)
- **prev**: 30-60 дней назад (для тренда)
- **all**: весь период (fallback)

### Когда использовать recent vs all:
```python
use_recent = recent_count >= 8  # Минимум 8 отзывов для статистики
```

---

## 5. Расчёт тренда

### Условия для расчёта:
- recent_count >= 3 И prev_count >= 3

### Интерпретация:
| Delta | Тренд | Значение |
|-------|-------|----------|
| > +0.1 | up | Улучшается |
| < -0.1 | down | Ухудшается |
| else | stable | Стабильно |

---

## 6. Формирование сигнала

### Приоритет сигналов:
1. **Вариант хуже среднего** — если avg(variant) ≤ rating - 0.4
2. **Повторяющаяся причина** — если причина встречается ≥ 2 раз за 30 дней
3. **Тренд вниз** — если trend = "down"

### Формулировка:
- Не "проблема", а "сигнал" — не пугаем
- Указываем источник: "12 отзывов, доверие: среднее"
- Показываем сравнение с другими вариантами

---

## 7. Уровни доверия

| Отзывов | Уровень | Что делать |
|---------|---------|------------|
| < 5 | низкое | "Мало данных, наблюдаем" |
| 5-20 | среднее | "Сигнал, проверить" |
| > 20 | высокое | "Подтверждённая проблема" |

---

## 8. Рекомендации (actions)

### Два типа проблем — два типа решений:

| Тип проблемы | Признаки | Рекомендация |
|--------------|----------|--------------|
| **Брак / дефект** | "сломался", "не работает", "пришёл битый" | Проверить партию, поставщика |
| **Ожидания ≠ реальность** | "тусклый", "маленький", "не такой как на фото" | Обновить описание, управлять ожиданиями |

### Примеры:
- "Батарея на 10 минут" → может быть брак ИЛИ неправильные ожидания
- "Красный тусклый" → 99% ожидания (физика света)
- "Протекает крышка" → 100% брак

### Структура рекомендации:
1. **Проверить** — если похоже на брак
2. **Обновить описание** — если несовпадение ожиданий
3. **Ответить** — в обоих случаях, но по-разному

### Формулировка:
- Конкретно: "Добавить в описание: красный режим для ночного зрения"
- Не абстрактно: "Улучшить описание"

---

## 9. Сравнение вариантов

### Что показываем:
- Топ-3 варианта по количеству отзывов
- Для каждого: rating, count, trend
- Выделяем проблемный (problem) vs остальные (ok)

### Вывод:
- "Проблема специфична для варианта X" — если только один плохой
- "Проблема относится ко всему товару" — если все плохие

---

## 10. Генерация ответа

### Принципы:
- Не извиняемся за то, что не подтверждено
- Объясняем особенность (красный режим для ночного зрения)
- Предлагаем решение (замена, если подтвердится)

### Шаблон:
```
Благодарим за отзыв. [Объяснение особенности].
[Действие: проверяем / уточним / поможем с заменой].
```

---

## Примеры рассуждений

### Пример 1: Фонарик красный режим
```
Вход: 12 отзывов, rating 4.08 (общий 4.79)
Причины: brightness 50%, battery 30%

Рассуждение:
1. Вариант "красный" — это РЕЖИМ свечения, не цвет корпуса
2. Один фонарик → разные режимы (белый, красный, синий, зелёный)
3. 4.08 < 4.79 - 0.4 = 4.39 → сигнал "хуже среднего"
4. Причина "тусклый" — физика: красный спектр воспринимается тусклее
5. Это НЕ брак — это несовпадение ожиданий

Вывод: "Режим красного спектра получает худшие оценки"
Причина: "Ожидания не совпадают с физикой красного света"
Действие: "Управлять ожиданиями в описании, не искать брак"
Ответ: "Красный режим специально тусклый — для ночного зрения"
```

### Пример 2: Термос Silver/Gold
```
Вход: Silver 4.1, Gold 3.9, остальные 4.7
Причина: "протекает крышка" — 11 раз за 8 дней

Рассуждение:
1. Проблема только в 2 вариантах из 16
2. Тренд: растёт (8 дней назад не было)
3. "Не протекает" — ключевое ожидание

Вывод: "Крышка протекает — только Silver и Gold"
Действие: "Проверить партию, остальные не трогать"
```

### Пример 3: Корм для кошек (pet_food)
```
Вход: 10 104 отзыва, rating 4.94, только 8 негативных из 100
Причины: flavor_mismatch 12%, pet_rejection 12%, прочее 50%

Рассуждение:
1. Рейтинг очень высокий (4.94) — критических проблем нет
2. Жалобы единичные, не формируют паттерн
3. "Прислали не тот вкус" — проблема логистики WB, не качества товара
4. "Кошка не ест" — индивидуальная непереносимость, не брак

Вывод: "Товар в порядке — мониторинг продолжается"
Действие: "Проверить логистику по пересортице вкусов"
Ответ: "Если прислали не тот вкус — напишите нам, поможем с обменом"
```
