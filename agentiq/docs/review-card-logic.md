# Логика карточки отзывов (MVP)

## Входные данные
Сырые результаты `get_results_fb` из API‑хоста (JSON), сохранённые в файл `task-XXX.json`.

## Цель
Сформировать компактный JSON карточки для фронта:
- метрики,
- сигнал/паттерн,
- варианты (цвет/размер),
- решение и действия,
- черновик ответа.

## Этапы обработки

### 1. Нормализация
Из каждого отзыва берём:
- `valuation` → рейтинг (1–5),
- `fb_text`, `advantages`, `disadvantages`, `problems`,
- `color` или `size` → вариант,
- `fb_created_at` → дата,
- `answer_text` → ответ есть/нет.

### 2. Метрики
Считаем:
- `feedback_count` — фактическое число отзывов в массиве `feedbacks`,
- `feedback_total` — значение `feedback_count` из API (если отличается от массива),
- `rating` (если пусто — пересчёт из распределения 1–5),
- `unanswered_count`,
- окно `WINDOW_DAYS = 30`: количество отзывов за 30 дней и число 3–4★.

### 3. Сигнал
Приоритет:
1. Если в последних 30 днях есть повторяющийся паттерн (>=2) — показываем свежий сигнал.
2. Иначе если общий паттерн >=3 — показываем общий сигнал.
3. Иначе — «сильного сигнала нет», показываем число 3–4★ за 30 дней.

Важно: список `problems` учитываем только в негативном контексте (низкая оценка, есть `disadvantages`, либо негативные слова в тексте). Позитивные теги отбрасываем.

### 4. Варианты
Группируем по `color`/`size`:
- считаем количество,
- среднюю оценку,
- долю низких оценок (<=3),
- статус `problem`, если ≥2 упоминаний проблемы или ≥20% низких оценок.

### 5. Решение
- если сигнал сильный — «проверить проблемные варианты и обновить описание»;
- если слабый — «держать под наблюдением 30 дней»;
- если нет — «срочных действий нет, улучшить FAQ/описание».

## Что выводим в карточку
- Заголовок и артикул
- 3 метрики: отзывы, рейтинг, без ответа
- Сигнал (title/text/source)
- 3 варианта с рейтингом и числом отзывов
- Решение + действия
- Черновик ответа

## Что пока не выводим
- Полные тексты отзывов
- Фото/видео
- Глубокие тематические кластеры

## Файл реализации
`agentiq/wbcon-task-to-card.py`

## Перегенерация карточки
```bash
python3 agentiq/wbcon-task-to-card.py agentiq/task-192.json agentiq/card-data-192.json
```
