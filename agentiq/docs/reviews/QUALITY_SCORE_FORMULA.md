# Quality Score Calculation (Формула оценки качества ответов)

## Формула расчёта (1-10 баллов) — ПРОЦЕНТНАЯ

### Базовый расчёт:
```
harmful_pct = (harmful / total_analyzed) × 100
risky_pct = (risky / total_analyzed) × 100
good_pct = (good / total_analyzed) × 100

quality_score = 10
  - (harmful_pct × 0.1)     # штраф за вредные ответы
  - (risky_pct × 0.05)      # штраф за рисковые ответы
  + (good_pct × 0.02)       # бонус за хорошие ответы

Ограничения: min = 1, max = 10, округление до целого
```

**ВАЖНО:** Формула основана на **процентах**, а не абсолютных числах.
5 harmful из 10 (50%) = плохо, 5 harmful из 200 (2.5%) = отлично.

## Классификация ответов

### Harmful (вредные) — снижают конверсию
- **blame** — Перекладывает вину («Читайте описание», «вы неправильно используете»)
- **ignore** — Игнорирует жалобу (благодарит за «позитивный отзыв» когда жалуются)
- **amplify** — Подтверждает проблему (признаёт несоответствие публично)
- **deny** — Отрицает проблему («у нас всё хорошо» когда проблема есть)
- **template** — Копипаст-шаблон на НЕГАТИВ (видно что не читают)
- **no_answer** — Без ответа на негативный отзыв

### Risky (рисковые) — ответы с проблемами
- Шаблонные ответы на позитив без жалоб (acceptable в зависимости от контекста)
- Отрицание проблемы не агрессивно

### Acceptable (приемлемые) — не вредят, не помогают
- Вежливый, но неконкретный ответ
- Шаблон на позитив БЕЗ жалоб («Спасибо за отзыв!»)

### Good (хорошие) — помогают продажам
- Эмпатия + конкретное решение
- Объяснение + помощь с настройкой
- Направление в ЛК WB если покупатель сам просил возврат

## Шкала оценок

| Балл | Описание | Типичное распределение |
|------|----------|------------------------|
| 1-3  | Катастрофа | >70% harmful ответов, игнорирование негатива |
| 4-5  | Плохо | 40-70% harmful, частые ошибки на негативе |
| 6-7  | Средне | Большинство acceptable, есть harmful на негативе |
| 8-10 | Хорошо | Большинство acceptable/good, минимум harmful |

## Примеры расчёта

### Пример 1: Отличная работа (10/10)
```
100 ответов:
- 70 acceptable (70%)
- 20 good (20%)
- 10 risky (10%)
- 0 harmful (0%)

Проценты: harmful=0%, risky=10%, good=20%
Расчёт: 10 - (0×0.1) - (10×0.05) + (20×0.02)
      = 10 - 0 - 0.5 + 0.4 = 9.9 → 10
Оценка: ★★★★★★★★★★ (10/10)
```

### Пример 2: Реальный кейс — Royal Canin (10/10)
```
202 ответа:
- 179 acceptable (88.6%)
- 10 good (5.0%)
- 8 risky (4.0%)
- 5 harmful (2.5%)

Проценты: harmful=2.5%, risky=4%, good=5%
Расчёт: 10 - (2.5×0.1) - (4×0.05) + (5×0.02)
      = 10 - 0.25 - 0.2 + 0.1 = 9.65 → 10
Оценка: ★★★★★★★★★★ (10/10)
```

### Пример 3: Средний уровень (8/10)
```
10 ответов:
- 7 acceptable (70%)
- 2 harmful (20%)
- 1 good (10%)

Проценты: harmful=20%, risky=0%, good=10%
Расчёт: 10 - (20×0.1) - 0 + (10×0.02)
      = 10 - 2 + 0.2 = 8.2 → 8
Оценка: ★★★★★★★★☆ (8/10)
```

### Пример 4: Плохо (3/10)
```
50 ответов:
- 20 acceptable (40%)
- 25 harmful (50%)
- 5 risky (10%)

Проценты: harmful=50%, risky=10%, good=0%
Расчёт: 10 - (50×0.1) - (10×0.05) + 0
      = 10 - 5 - 0.5 = 4.5 → 5 (округлено вверх)
Оценка: ★★★★★ (5/10)
```

### Пример 5: Катастрофа (1/10)
```
100 ответов:
- 10 acceptable (10%)
- 80 harmful (80%)
- 10 risky (10%)

Проценты: harmful=80%, risky=10%, good=0%
Расчёт: 10 - (80×0.1) - (10×0.05) + 0
      = 10 - 8 - 0.5 = 1.5 → 2 (округлено вверх)
Можно занизить до 1 если все harmful на критичном негативе
Оценка: ★ (1/10)
```

## Контекст важен!

Один и тот же ответ классифицируется по-разному:

| Ответ | На отзыв | Классификация | Причина |
|-------|----------|---------------|---------|
| «Спасибо за отзыв!» | ★★★★★ без жалоб | acceptable | Норма для позитива |
| «Спасибо за отзыв!» | ★ с жалобой | harmful (ignore) | Игнорирует проблему |
| Шаблон «Рады что понравилось» | ★★★★★ | acceptable | Не вредит |
| Тот же шаблон | ★★ | harmful (template) | Видно что не читают |

## Почему формула справедлива?

1. **Стартуем с 10** — презумпция качества, не занижаем без причины
2. **Harmful на негатив × 2** — критично важно правильно отвечать на жалобы
3. **Harmful на позитив × 1.5** — меньший вес, но всё равно вредит
4. **Risky × 0.5** — небольшие проблемы, не катастрофа
5. **Good × 0.3** — бонус, но небольшой (норма = acceptable)

## Money Loss — связь с Quality Score

Потери конверсии зависят от качества ответов (см. `wbcon-task-to-card-v2.py:217-222`):

| Quality Score | CR Impact (потери) | Описание |
|---------------|-------------------|----------|
| 7-10 | 1-2% | Минимальные потери, отличная работа |
| 4-6 | 2-4% | Средние потери, есть проблемы |
| 1-3 | 3-6% | Критичные потери, катастрофа |

**Формула money_loss:**
```
purchases_per_month = (review_count / period_months) / review_rate (3-5%)
revenue_per_month = purchases_per_month × price
loss_per_month = revenue_per_month × CR_impact
```

**Пример (Royal Canin):**
```
Reviews: 202 за 12 мес
Purchases: 202 / 12 / 0.04 = 421 покупок/мес (при review_rate=4%)
           = 144-240 /мес (диапазон 3-5% review_rate)
Price: 2,499 ₽
Revenue: 144 × 2,499 = 359,856 ₽/мес (min)
         240 × 2,499 = 599,760 ₽/мес (max)
Quality: 10/10 → CR impact 1-2%
Loss: 359,856 × 1% = 3,599 ₽/мес
      599,760 × 2% = 11,995 ₽/мес
```

## Обновления

**2026-02-07**:
- Добавлена процентная формула в LLM промпт (`llm_analyzer.py:639-655`) вместо абсолютной
- Обновлена документация с реальными примерами
- Исправлен расчёт money_loss (revenue = purchases × price, НЕ базовая цена × множитель)
