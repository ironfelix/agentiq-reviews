# Guardrails для ответов на отзывы

## 1. Формат рекомендации ("Как стоило ответить")

### Правильно: готовый текст от лица продавца
```
«Нам очень жаль за эту ситуацию. Это недопустимо — вы заказывали Benetton
и должны были получить именно его. Оформите, пожалуйста, возврат через ЛК WB
с пометкой "не соответствует описанию" — возврат бесплатный. Мы уже передали
информацию для проверки комплектации на складе.»
```

### Неправильно: инструкция/размышление
```
«Стоило извиниться за недопонимание и вежливо объяснить, что товар
соответствует описанию на карточке. Предложить помощь...»
```

### Структура хорошего ответа (2-3 предложения, макс 300 символов):
1. **Эмпатия** — "Нам жаль", "Понимаем разочарование", "Спасибо за обратную связь"
2. **Конкретика** — объяснение ИЛИ действие ИЛИ инструкция
3. **Открытый диалог** — "Если нужна помощь — напишите нам"

## 2. Banned phrases (НИКОГДА)

| Фраза | Почему запрещена |
|-------|-----------------|
| "вернём деньги" | Ложное обещание — продавец не контролирует возвраты на WB |
| "гарантируем возврат/замену" | То же — возвраты через WB, не через продавца |
| "полный возврат" | Обещание без полномочий |
| "бесплатную замену" | Продавец не может гарантировать замену через WB |
| "вы неправильно" | Обвинение покупателя |
| "вы не так" | Обвинение покупателя |
| "ваша вина" | Агрессия |
| "сами виноваты" | Агрессия |
| "обратитесь в поддержку" | Отписка, ничего не решает |
| "ИИ", "бот", "нейросеть" | Раскрывает автоматизацию |
| "GPT", "ChatGPT" | Раскрывает автоматизацию |

## 3. Условные правила

### Возврат — только по запросу покупателя
**Триггеры** (покупатель сам упомянул): "возврат", "вернуть", "замена", "заменить", "обменять", "обмен"

- **Триггер ЕСТЬ** → можно написать: "Оформите возврат через ЛК WB как «не соответствует описанию»"
- **Триггера НЕТ** → только: эмпатия + объяснение + помощь. НЕ предлагать возврат самостоятельно

### Подтверждение проблемы — осторожно
- НЕ писать: "характеристики не соответствуют заявленным" (= признание обмана)
- Писать: "нештатная ситуация", "возможен дефект конкретного экземпляра", "передали в отдел качества"

### Fashion-специфика
- Тонкая ткань → "100% хлопок — лёгкий и дышащий, для светлых цветов рекомендуем бельё в тон"
- Цвет не соответствует → "оттенок может отличаться в зависимости от экрана, учтём для описания"
- Подмена бренда → серьёзно отнестись, инструкция по возврату, "запустили проверку партии"

## 4. Классификация ответов (risk_type)

### Ошибки (вредят):
| risk_type | Название | Описание |
|-----------|----------|----------|
| blame | Перекладывает вину | "Читайте описание", "вы неправильно используете" |
| ignore | Игнорирует жалобу | Покупатель жалуется — продавец благодарит за "позитивный отзыв" |
| amplify | Подтверждает проблему | Продавец сам признаёт несоответствие описанию |
| deny | Отрицает проблему | "У нас всё хорошо" когда проблема очевидна |
| template | Копипаст-шаблон | Одинаковый текст на жалобы и похвалы |
| no_answer | Без ответа | Не ответил на негативный отзыв |

### Нейтральные/Хорошие:
| risk_type | Название | Описание |
|-----------|----------|----------|
| ok | Нормальный | Вежливый, но неконкретный — не вредит, не помогает |
| good | Хороший | Эмпатия + конкретное решение или объяснение |

## 5. Лимиты

| Параметр | Значение |
|----------|----------|
| Длина ответа (recommendation) | 20-300 символов |
| Действия (action_plan) | макс 3, каждое 5-120 символов |
| Root cause types | expectation_mismatch, defect, design_flaw, description_gap |
| Strategy title | макс 40 символов |
| Explanation items | макс 3, каждое до 150 символов |

## 6. Примеры хороших ответов по типам проблем

### Брак / дефект
```
«Нам очень жаль! Такое отклонение — нештатная ситуация, возможен дефект
конкретного экземпляра. Мы передали информацию в отдел качества для проверки
партии. Напишите нам, поможем разобраться!»
```

### Несоответствие описанию (цвет/размер)
```
«Спасибо за обратную связь! Оттенок "бежевый" действительно имеет сероватый
подтон, учтём для описания. По размеру рекомендуем ориентироваться на замеры
в карточке.»
```

### Тонкая ткань (fashion)
```
«Благодарим за отзыв! Эта модель из 100% хлопка — лёгкая и дышащая, поэтому
светлые оттенки могут просвечивать. Для белого рекомендуем нижнее бельё в тон.»
```

### Подмена товара / подделка
```
«Нам очень жаль. Все наши изделия проходят контроль подлинности. Описанная
ситуация нетипична — возможна ошибка при комплектации. Оформите возврат через
ЛК WB как "не соответствует описанию". Мы запустили проверку этой партии.»
```

### Быстро разряжается (электроника)
```
«Благодарим за отзыв! Нам жаль, что время работы не оправдало ожиданий.
На автономность влияет режим яркости и температура — на минимальном режиме
фонарик работает значительно дольше. Если нужна помощь с настройкой — пишите!»
```

### Покупатель хвалит, но упоминает минус (скрытая жалоба)
```
«Сергей, спасибо за подробный тест! 5 часов без потери яркости — отличный
результат. По индикатору зарядки — он расположен на кнопке и светится
красным/зеленым при подключении кабеля. Если не загорается — напишите нам!»
```

## 7. Chat Policy Pipeline

Чаты — это диалог в реальном времени. В отличие от отзывов, здесь нужно не анализировать ответ продавца, а **сгенерировать правильный ответ**. Pipeline обрабатывает каждый чат последовательно:

```
Intent Classification → SLA Priority → Safety Policies → Action Policy → Escalation Check
```

### 7.1. Классификация интента (intent)

Каждый чат классифицируется в один из 8 интентов:

| Intent | Описание | Пример сообщения клиента |
|--------|----------|--------------------------|
| `delivery_status` | Где мой заказ? | "Когда доставят?", "Где посылка?" |
| `delivery_delay` | Заказ задерживается | "Жду уже 2 недели", "Заказ не приходит" |
| `cancel_request` | Хочу отменить | "Отменить заказ", "Не хочу ждать, отмена" |
| `wrong_item` | Прислали не тот товар | "Это не то что заказывал", "Другой цвет/размер" |
| `defect_not_working` | Брак, не работает | "Сломано", "Не включается", "Дефект" |
| `usage_howto` | Как пользоваться? | "Как подключить?", "Какой размер выбрать?" |
| `product_spec` | Характеристики товара | "Из чего сделано?", "Какой состав?" |
| `refund_exchange` | Возврат или обмен | "Хочу вернуть", "Как оформить возврат?" |

Если интент неясен — `usage_howto` (задать уточняющий вопрос).

### 7.2. SLA-приоритеты

> **Полные правила SLA с источниками и обоснованием:** [`docs/SLA_RULES.md`](../SLA_RULES.md)

| Приоритет | Время ответа | Интенты | Условие |
|-----------|-------------|---------|---------|
| **P0** | < 30 мин | `defect_not_working`, `wrong_item` | Брак / не тот товар — urgent |
| **P0** | < 15 мин | Упоминание суда, Роспотребнадзора | Юридическая угроза |
| **P1** | **< 2 мин** (AI auto) | Pre-purchase чат (`sizing_fit`, `availability`, `compatibility`) | Покупатель СЕЙЧАС на карточке, окно решения 10-20 сек |
| **P1** | **< 5 мин** (AI draft) | Pre-purchase вопрос (Questions API) | Публичный вопрос, покупатель может вернуться |
| **P1** | < 1 часа | `delivery_delay`, `cancel_request`, `return_refund`, `missing_parts` | Клиент раздражён |
| **P2** | < 4 часов | `refund_exchange`, `delivery_status`, `quality_complaint`, `usage_question` | Стандартный запрос |
| **P3** | < 24 часов | `usage_howto`, `product_spec`, `positive_feedback` | Информационный / позитив |

**Почему pre-purchase < 2 мин, а не < 1 час:**
- Покупатель сравнивает товары в real-time, **окно решения 10-20 секунд**
- WB статистика +20% конверсии за ответ в 1ч — это **минимальный порог** для человека
- AI может ответить за секунды → это конкурентное преимущество, большинство продавцов отвечают часами
- Через 10 минут покупатель уже купил у конкурента или ушёл

**Повышение приоритета:**
- Повторные сообщения (2+ раз то же самое) → P0
- Капслок / восклицательные знаки / угрозы → повысить на 1 уровень
- Клиент ждёт >3 дней без ответа → P0

### 7.3. Safety Policies (3 группы)

#### Группа A: Ложный авторитет (False Authority)
Продавец на WB **НЕ может**: отменить заказ, изменить адрес, ускорить доставку, вернуть деньги, одобрить/отклонить возврат, гарантировать сроки.

| Запрещено | Почему | Замена |
|-----------|--------|--------|
| "мы одобрим возврат/заявку" | Продавец не контролирует решение по возвратам на WB | "Оформите возврат через ЛК WB" |
| "мы отменим ваш заказ" | Нет таких полномочий | "Вы можете отменить заказ в ЛК WB" |
| "доставим завтра" / "через N дней будет" | Продавец не контролирует логистику | "Со своей стороны проверили — товар передан в доставку" |
| "вернём деньги" / "гарантируем замену" | Ложное обещание | "Оформите возврат через ЛК WB" |
| "ускорим доставку" | Нет полномочий | "Со своей стороны товар отгружен" |
| "изменим адрес доставки" | Нет полномочий | "Адрес можно изменить в ЛК WB до отправки" |

#### Группа B: Модерация WB
Ответ продавца проходит модерацию WB. Нарушение → штраф / блокировка.

| Запрещено | Почему |
|-----------|--------|
| Контакты вне WB (телефон, email, Telegram) | Увод клиента с площадки |
| "ИИ", "бот", "нейросеть", "GPT" | Раскрытие автоматизации |
| Оскорбления, сарказм, пассивная агрессия | Нарушение правил площадки |
| "пересорт", "FBO/FBS", "SKU" | Внутренний жаргон, клиент не поймёт |

#### Группа C: Юридические признания (Legal Admissions)
Формулировки, которые могут быть использованы как доказательство.

| Запрещено | Почему | Замена |
|-----------|--------|--------|
| "характеристики не соответствуют заявленным" | Признание обмана в описании | "Возможен дефект конкретного экземпляра" |
| "наша ошибка" / "мы виноваты" | Признание вины = основание для иска | "Нештатная ситуация, разбираемся" |
| "это подделка" / "некачественный товар" | Признание контрафакта | "Описанная ситуация нетипична, запустили проверку" |
| "мы знали о проблеме" | Преднамеренность | Не упоминать |

### 7.4. Action Policies по интентам

Для каждого интента — конкретная политика действий и шаблон ответа.

#### `delivery_status` — Где мой заказ?
**Политика:** Продавец не контролирует доставку, но показывает вовлечённость.
```
«{Имя}, здравствуйте! Проверили ваш заказ — со своей стороны товар отгружен
и передан в службу доставки WB. Отслеживать статус удобнее всего в ЛК WB.
Если возникнут вопросы — пишите!»
```

#### `delivery_delay` — Заказ задерживается
**Политика:** Признать проблему, показать действие, не обещать сроки.
```
«{Имя}, здравствуйте! Понимаем — ожидание затянулось. Со своей стороны
проверили: товар был передан в доставку {дата}. К сожалению, на сроки
логистики мы повлиять не можем, но если заказ не поступит в ближайшие дни —
напишите нам, поможем разобраться.»
```

#### `cancel_request` — Хочу отменить
**Политика:** Не отговаривать, дать инструкцию. Если причина — задержка, признать.
```
«{Имя}, здравствуйте! Вы можете отменить заказ в ЛК WB: раздел
"Доставки" → "Отменить". Если хотите заказать снова позже — будем рады!»
```

#### `wrong_item` — Прислали не тот товар
**Политика:** Извиниться, дать инструкцию по возврату сразу (не ждать запроса — проблема очевидна).
```
«{Имя}, здравствуйте! Приносим извинения — такого не должно быть. Оформите,
пожалуйста, возврат через ЛК WB с пометкой "не соответствует описанию" —
это бесплатно. Мы передали информацию для проверки комплектации.»
```

#### `defect_not_working` — Брак, не работает
**Политика:** Извиниться, дать инструкцию по возврату сразу (очевидный дефект).
```
«{Имя}, здравствуйте! Нам очень жаль — это нештатная ситуация. Оформите,
пожалуйста, возврат через ЛК WB. Мы передали информацию в отдел качества
для проверки партии.»
```

#### `usage_howto` — Как пользоваться?
**Политика:** Ответить конкретно, из данных карточки товара. Не выдумывать характеристики.
```
«{Имя}, здравствуйте! {Конкретный ответ из карточки товара}.
Если нужна дополнительная информация — пишите!»
```

#### `product_spec` — Характеристики товара
**Политика:** Дать информацию из карточки. Если артикул неизвестен — уточнить.
```
«{Имя}, здравствуйте! По данным карточки: {характеристика из карточки}.
Если нужны другие подробности — уточните, пожалуйста!»
```

#### `refund_exchange` — Возврат или обмен
**Политика:** Клиент сам инициировал — дать инструкцию.
```
«{Имя}, здравствуйте! Оформить возврат можно в ЛК WB: раздел "Покупки" →
выбрать товар → "Оформить возврат". Если возникнут сложности — пишите!»
```

### 7.5. Логика возврата — по классу проблемы, не по триггер-слову

Старое правило «предлагать возврат только если клиент сам упомянул» заменяется на:

| Класс проблемы | Возврат | Логика |
|----------------|---------|--------|
| `defect_not_working` | Предлагать сразу | Товар неисправен — возврат очевиден |
| `wrong_item` | Предлагать сразу | Получил не то — нечего ждать |
| `delivery_delay` | НЕ предлагать | Товар ещё в пути, может прийти |
| `cancel_request` | Инструкция по отмене | Клиент сам хочет, дать путь |
| `usage_howto` | НЕ предлагать | Товар нормальный, нужна помощь |
| `product_spec` | НЕ предлагать | Информационный запрос |
| `refund_exchange` | Инструкция по возврату | Клиент сам инициировал |
| `delivery_status` | НЕ предлагать | Товар в процессе доставки |

**Важно:** Даже когда возврат предлагается сразу — **без обещаний результата**. Только инструкция "Оформите через ЛК WB".

### 7.6. Banned phrases для чатов (сводная таблица)

| Фраза | Группа | Что писать вместо |
|-------|--------|-------------------|
| "мы одобрим возврат/заявку" | A: False Authority | "Оформите возврат через ЛК WB" |
| "вернём деньги" / "гарантируем замену" | A: False Authority | "Оформите возврат через ЛК WB" |
| "доставим завтра" / "через N дней" | A: False Authority | "Со своей стороны проверили — товар передан в доставку" |
| "отменим ваш заказ" | A: False Authority | "Вы можете отменить заказ в ЛК WB" |
| "ускорим доставку" | A: False Authority | "Со своей стороны товар отгружен" |
| "обратитесь в поддержку WB" | Отписка | "Мы со своей стороны проверим ситуацию" |
| "мы не можем повлиять" | Бессилие | "Со своей стороны мы передали информацию" |
| "подскажите, какой вопрос?" | Бессмыслица | Ответить на конкретный вопрос |
| "пересорт" / "FBO" / "SKU" | B: Модерация WB | "Прислали не тот товар" / "несоответствие" |
| "уважаемый клиент/покупатель" | Канцелярит | По имени или просто "Здравствуйте!" |
| "ИИ" / "бот" / "нейросеть" / "GPT" | B: Модерация WB | Не упоминать |
| "характеристики не соответствуют" | C: Legal | "Возможен дефект конкретного экземпляра" |
| "наша ошибка" / "мы виноваты" | C: Legal | "Нештатная ситуация, разбираемся" |

## 8. Chat Policy Engine (runtime)

Эти правила применяются автоматически при анализе чатов — и в промпте LLM, и в post-processing.

### 8.1. Формат ответа

**Структура (2-3 предложения, макс 300 символов):**
1. **Приветствие** — "{Имя}, здравствуйте!" (по имени, не "Уважаемый клиент")
2. **Конкретный ответ** — действие или объяснение (НЕ отсылка)
3. **Открытость** — "Если нужна помощь — пишите"

**Тон = тон клиента:**
| Клиент пишет | Тон ответа |
|-------------|------------|
| Формально | Деловой, вежливый |
| Нейтрально | Дружелюбный |
| Неформально / зло | Простой, без канцелярита, спокойный |

### 8.2. When-to-ask vs When-to-answer

| Ситуация | Действие |
|----------|----------|
| Интент ясен, данные есть | **Отвечать сразу** — не задавать лишних вопросов |
| Интент ясен, не хватает данных (артикул, номер заказа) | **Уточнить** — "Подскажите, пожалуйста, номер заказа" |
| Интент неясен | **Уточнить** — "Подскажите, пожалуйста, что именно произошло?" |
| Клиент описал проблему подробно | **Отвечать** — не переспрашивать то, что уже сказано |
| Клиент повторяет сообщение | **Отвечать** — повтор = раздражение, не надо ещё раз уточнять |

**Антипаттерн:** "Подскажите, какой у вас вопрос?" — если вопрос уже задан в сообщении.

### 8.3. Повторные сообщения = эскалация

Если клиент отправил одно и то же 2+ раз, или пишет несколько дней подряд с нарастающей эмоцией:

- Sentiment → "Негативная"
- Priority → P0
- В ответе: **признать задержку** ("Приносим извинения за задержку с ответом"), НЕ игнорировать повторы

Паттерны эскалации:
- "Где товар" → "ГДЕ ТОВАР???" → "Имейте совесть!" = P0
- Одно сообщение 2 раза подряд = раздражение

### 8.4. Авто-сообщения WB — игнорировать

Признаки: автор содержит `[авто]`, шаблонный текст ("Здесь вы можете задать вопросы...").

- НЕ считать ответом продавца
- НЕ дублировать текст в рекомендации
- Если в чате только авто-сообщение — статус "Без ответа"

### 8.5. Пустые и технические сообщения — пропускать

- Пустой `text` или только пробелы → не считать за сообщение
- Не увеличивать счётчик непрочитанных
- Часто это глюк WB Chat API

### 8.6. Не выдумывать характеристики

AI использует **только** данные из карточки товара. Если артикул неизвестен — спросить, не придумывать.

### 8.7. Мёртвый чат (>30 дней, продавец ответил)

- Статус: "Архив"
- Urgency: "Низкая"
- aiSuggestion: "Чат архивный. Реагировать если клиент напишет снова."
- НЕ писать клиенту первым в старый чат

### 8.8. Не извиняться за ошибку клиента

Если клиент ошибся сам (заказал не тот размер, не прочитал описание):
- Эмпатия: ДА ("Понимаем ситуацию")
- Вина: НЕТ ("Приносим извинения за ошибку" — запрещено)

### 8.9. Один ответ — одно действие

Максимум: 1 инструкция + 1 fallback ("напишите нам, если...").
НЕ перегружать: "Оформите возврат, потом закажите заново, а ещё напишите в поддержку WB".

### 8.10. Escalation Rules

Некоторые чаты **нельзя** обрабатывать автоматически — нужен человек.

| Триггер | Действие | Почему |
|---------|----------|--------|
| Аллергия / здоровье / мед. реакция | **STOP** → менеджеру | Медицинский риск, юридическая ответственность |
| Подозрение на контрафакт | **STOP** → менеджеру | Юридический риск, проверка партии |
| Угрозы / юридические претензии | **STOP** → менеджеру | "Подам в суд", "напишу в Роспотребнадзор" |
| Массовый дефект (3+ жалобы на то же) | **FLAG** → менеджеру | Системная проблема, нужна проверка партии |
| Персональные данные в чате | **STOP** → не обрабатывать | Паспорт, адрес, банковские данные |

**STOP** = AI не отвечает, только помечает чат как требующий ручного разбора.
**FLAG** = AI может ответить, но помечает для проверки менеджером.

### 8.11. Статус "Клиент ответил повторно"

Когда продавец уже ответил, а клиент написал снова:
- **"Спасибо"** → "Рады помочь! Если возникнут вопросы — обращайтесь."
- **"Доставили/получил"** → "Рады, что всё дошло! Будем благодарны за отзыв."
- **Новый вопрос** → Классифицировать как новый интент, ответить конкретно

### 8.12. Авто-ответ: тайминги и правила

> **Полная документация:** [`docs/SLA_RULES.md`](../SLA_RULES.md) — секции B и D

**Принцип:** НЕ мгновенный ответ. Задержка 3-8 сек + typing indicator → feels human.

| Тип | Задержка | Auto-send? | Одобрение |
|-----|----------|------------|-----------|
| **Pre-purchase чат** | 3-5 сек | **Да** | AI auto — покупатель ждёт |
| **Pre-purchase вопрос** | 3-5 сек | **Да** | AI auto для стандартных (размер, состав, наличие) |
| **Чат (urgent)** | 3-5 сек | Да | AI auto |
| **Чат (normal)** | 5-8 сек | Да | AI auto |
| **Отзыв (позитив)** | 5-10 сек после одобрения | Нет | Seller одобряет → send |
| **Отзыв (негатив)** | — | **НЕТ** | **ОБЯЗАТЕЛЬНО** одобрение продавца |

**Критические правила:**
1. **НИКОГДА** авто-отправка на негативный отзыв — только draft → одобрение
2. Варьировать задержку (random 3-8с) — фиксированная = механически
3. Формула: `delay = 3 + (word_count / 40)`, max 12 сек
4. Typing indicator во время задержки в чатах
5. Первый ответ в разговоре — быстрее (2-3 сек, acknowledgment)
6. 09:00-21:00 MSK — короче (3-5с), ночь — длиннее (5-10с)
