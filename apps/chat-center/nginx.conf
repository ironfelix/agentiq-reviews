# AgentIQ Chat Center — nginx config
# VPS: 79.137.175.164
# Домен (prod): agentiq.ru
#
# Структура:
#   /              → landing.html (статика, главная до входа)
#   /app           → React SPA (Chat Center)
#   /api           → FastAPI backend (proxy)
#
# Установка:
#   sudo cp nginx.conf /etc/nginx/sites-available/agentiq
#   sudo ln -sf /etc/nginx/sites-available/agentiq /etc/nginx/sites-enabled/
#   sudo nginx -t && sudo systemctl reload nginx

# ========================================
# RATE LIMITING (top-level zones)
# ========================================
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=30r/s;
limit_conn_zone $binary_remote_addr zone=addr:10m;

# ========================================
# DEV/STAGING — по IP без домена
# ========================================
server {
    listen 80 default_server;
    server_name 79.137.175.164;

    root /var/www/agentiq;

    # Landing page — главная до входа
    location = / {
        try_files /landing.html =404;
    }

    # React SPA (Chat Center)
    location /app/ {
        alias /var/www/agentiq/app/;
        try_files $uri $uri/ /app/index.html;
    }

    # Static asset caching (JS/CSS/images/fonts)
    location ~* \.(js|css|png|jpg|jpeg|gif|svg|ico|woff|woff2|ttf|eot)$ {
        root /var/www/agentiq;
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # API — proxy to FastAPI backend
    location /api/ {
        proxy_pass http://127.0.0.1:8001/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Proxy timeouts (AI tasks can take 2-5 min)
        proxy_read_timeout 300s;
        proxy_connect_timeout 10s;
        proxy_send_timeout 60s;

        # Request limits
        client_max_body_size 10M;
        limit_req zone=api_limit burst=50 nodelay;
        limit_conn addr 20;
    }

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;

    # Gzip
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml;
    gzip_min_length 1000;
}

# ========================================
# PRODUCTION — после привязки домена agentiq.ru
# ========================================
# 1. Поменять server_name на agentiq.ru www.agentiq.ru
# 2. Запустить: sudo certbot --nginx -d agentiq.ru -d www.agentiq.ru
# 3. Certbot автоматически добавит SSL и redirect 80→443
# 4. Автопродление: см. scripts/ops/README-ssl.md
#
# SSL Auto-Renewal (Let's Encrypt):
#   - Certbot автоматически настраивает systemd timer (certbot.timer)
#   - Проверка: sudo systemctl list-timers | grep certbot
#   - Мониторинг: scripts/ops/ssl-check.sh (см. README-ssl.md)
#
# server {
#     listen 80;
#     server_name agentiq.ru www.agentiq.ru;
#     return 301 https://$host$request_uri;
# }
#
# server {
#     listen 443 ssl http2;
#     server_name agentiq.ru www.agentiq.ru;
#
#     ssl_certificate /etc/letsencrypt/live/agentiq.ru/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/agentiq.ru/privkey.pem;
#     include /etc/letsencrypt/options-ssl-nginx.conf;
#     ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
#
#     root /var/www/agentiq;
#
#     location = / { try_files /landing.html =404; }
#     location /app/ { alias /var/www/agentiq/app/; try_files $uri $uri/ /app/index.html; }
#
#     # Static asset caching (JS/CSS/images/fonts)
#     location ~* \.(js|css|png|jpg|jpeg|gif|svg|ico|woff|woff2|ttf|eot)$ {
#         root /var/www/agentiq;
#         expires 1y;
#         add_header Cache-Control "public, immutable";
#         access_log off;
#     }
#
#     location /api/ {
#         proxy_pass http://127.0.0.1:8001/api/;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_http_version 1.1;
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection "upgrade";
#
#         # Proxy timeouts (AI tasks can take 2-5 min)
#         proxy_read_timeout 300s;
#         proxy_connect_timeout 10s;
#         proxy_send_timeout 60s;
#
#         # Request limits
#         client_max_body_size 10M;
#         limit_req zone=api_limit burst=50 nodelay;
#         limit_conn addr 20;
#     }
#
#     # Security headers
#     add_header X-Frame-Options "SAMEORIGIN" always;
#     add_header X-Content-Type-Options "nosniff" always;
#
#     gzip on;
#     gzip_types text/plain text/css application/json application/javascript text/xml;
#     gzip_min_length 1000;
# }
