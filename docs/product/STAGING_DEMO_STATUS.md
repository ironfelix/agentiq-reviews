# Staging Demo Status (Chat Center / Unified Inbox)

**Дата:** 2026-02-12

## Где смотреть демо

- Landing: `http://79.137.175.164/`
- App: `http://79.137.175.164/app/`
- API health: `http://79.137.175.164/api/health`

Примечание: это staging по IP, работает по HTTP. Прод по домену остаётся на HTTPS.

## Что сейчас считается “MVP demo” (CJM)

Цель: пройти путь **регистрация → подключение Wildberries → сообщения** без зависаний, с понятными состояниями.

1. Регистрация / логин в приложении.
2. Экран подключения WB:
   - `Подключить и загрузить` (ввод ключа WB).
   - `Пропустить, посмотрю сначала` (demo-mode).
3. Экран “Сообщения”:
   - единый inbox (в базе: unified `interactions`),
   - пустые/ошибочные состояния не ломают навигацию.

## Что было сломано и что исправлено

1. **`http://79.137.175.164/app/` отдавал 404**
   - Причина: Nginx на 80 порту возвращал 404 для IP (Certbot-конфиг).
   - Исправление: добавлен отдельный HTTP `server` для `79.137.175.164`, который раздаёт `/` и `/app/` и проксирует `/api/`.

2. **Дублирующий systemd-сервис `agentiq-chat` уходил в restart-loop**
   - Причина: порт `127.0.0.1:8001` уже занят сервисом `agentiq-api` (оба пытались поднять uvicorn на одном порту).
   - Исправление: `agentiq-chat` остановлен и отключен. Рабочий API остаётся в `agentiq-api`.

3. **UI зависал на “Синхронизация …” без понятного выхода**
   - Исправление в UI: при `has_api_credentials=true` и `sync_status=syncing` показывается v3 экран подключения с кнопкой “Перейти к сообщениям”.
   - Исправление в backend: если фон не стартует (очередь/Celery), `sync_status` переводится в `error`, чтобы не было вечного `syncing`.

4. **Фоновая синхронизация с неверным WB ключом**
   - Исправление: в `sync_seller_chats` ошибки WB auth (`401/403`) считаются неретрайбл.
   - Результат: при “битом” ключе seller быстро получает `sync_status=error` + `sync_error`, UI может показать retry.

5. **Схема БД (staging) не совпадала с новой логикой**
   - Добавлены (idempotent) поля:
     - `sellers.sync_status`, `sellers.sync_error`
     - `chats.closed_at`

6. **`/app/` открывался, но не грузился (JS/CSS не подхватывались)**
   - Симптом: страница выглядела как “лендинг”/пустая, в консоли 404 по ассетам.
   - Причина: Vite build кладёт ассеты в `dist/assets/*` и ссылается на них как `/assets/*`,
     а деплой складывал `assets/` внутрь `/var/www/agentiq/app/assets`, из-за чего `/assets/*` не находились.
   - Исправление: на staging ассеты раскладываются в `/var/www/agentiq/assets/*`, а SPA entry — в `/var/www/agentiq/app/index.html`.

7. **Даты в “Вопросах/Отзывах” показывались как “сегодня”**
   - Причина: баг в `_parse_iso_dt()` приводил к `occurred_at=NULL` при ingestion review/question.
   - Исправление: восстановлен корректный ISO parsing и нормализация в UTC.

8. **“Отвечено”, но текст ответа продавца не показывался**
   - Причина: ingestion не сохранял ответ WB в `extra_data.last_reply_text`, UI не мог построить outgoing message.
   - Исправление: для review/question сохраняем `last_reply_text` (+ source/ts), UI показывает ответ как исходящее сообщение.

9. **В чатах не было “полной истории”**
   - Причина: unified inbox рендерил synthetic 1-2 сообщения из `Interaction`, игнорируя `messages` таблицу.
   - Исправление: для `channel=chat` UI грузит реальные сообщения через `chat_id` из `interaction.extra_data`.

## Как сейчас руками проверить (быстро)

1. Открыть `http://79.137.175.164/app/`.
2. Зарегистрироваться (email должен быть валидным, используйте домен типа `name@example.com`, не `.local`).
3. На экране подключения:
   - вставить WB API key и нажать `Подключить и загрузить чаты`
   - или нажать `Пропустить, посмотрю сначала`
4. В “Сообщениях”:
   - если синк идёт, можно сразу `Перейти к сообщениям` (без ожидания),
   - если синк упал, будет статус ошибки и возможность retry.
5. После деплоя фиксов ingestion:
   - нажать `Повторить` (retry sync), чтобы бэкенд перезаполнил `occurred_at` и подтянул `last_reply_text` из WB.

## Важное про WB токены (почему “чаты не грузятся”, но отзывы/вопросы могут работать)

- Для **WB Buyers Chat API** токен должен быть **JWT** (строка из 3 сегментов через точку: `header.payload.signature`).
  Если токен не JWT, синк чатов завершится `sync_status=error` с `wb_token_invalid`, и в UI появится ошибка синхронизации.
- Для **feedbacks/questions** (эндпоинты `feedbacks-api.wildberries.ru`) WB исторически принимал разные форматы `Authorization`,
  поэтому reviews/questions могут продолжать работать даже если chat token не подходит.

## Статус отправки ответов (reply)

- `POST /api/interactions/{id}/reply` реализован для каналов `review`, `question`, `chat`.
- Для `review/question` ответ уходит в WB API, а в unified inbox сразу фиксируется как `responded`.
  Если WB не отражает ответ мгновенно (модерация/пропагация), обращение остаётся “закрытым” локально в коротком окне
  (см. `extra_data.wb_sync_state=pending`).

## Что осталось до “первого демо” (для зрителей)

- Сделать один “чистый” demo seller на staging (подключённый корректным WB ключом), чтобы inbox был не пустой.
- Мини-smoke сценарий прямо в UI (без скриптов): register → connect → messages → открыть 1 обращение.
- Опционально: добавить отдельный `/api/health` (или nginx route на `/health`) чтобы легче мониторить без SSH.
