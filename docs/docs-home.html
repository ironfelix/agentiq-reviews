<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AgentIQ — Documentation Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --color-bg: #fafbfc;
      --color-card: #ffffff;
      --color-text: #1a1a1a;
      --color-text-secondary: #5f6368;
      --color-text-tertiary: #9aa0a6;
      --color-accent: #1a73e8;
      --color-success: #34a853;
      --color-danger: #ea4335;
      --color-warning: #f9ab00;
      --color-border: #e8eaed;
      --shadow: 0 12px 30px rgba(16, 24, 40, 0.08);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--color-bg);
      color: var(--color-text);
      line-height: 1.65;
      padding: 40px 20px;
    }

    .container { max-width: 1060px; margin: 0 auto; }

    h1 {
      font-size: 34px;
      font-weight: 700;
      letter-spacing: -0.02em;
      margin-bottom: 8px;
    }

    .subtitle {
      font-size: 16px;
      color: var(--color-text-secondary);
      margin-bottom: 12px;
      max-width: 92ch;
    }

    .meta {
      color: var(--color-text-tertiary);
      font-size: 13px;
      margin-bottom: 26px;
    }

    .section {
      background: var(--color-card);
      border-radius: 12px;
      padding: 32px;
      margin-bottom: 24px;
      border: 1px solid var(--color-border);
      box-shadow: var(--shadow);
    }

    h2 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    h3 {
      font-size: 18px;
      font-weight: 600;
      margin-top: 24px;
      margin-bottom: 12px;
      color: var(--color-accent);
    }

    p { margin-bottom: 12px; }

    a { color: var(--color-accent); text-decoration: none; }
    a:hover { text-decoration: underline; }

    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 7px;
      color: #fff;
      font-weight: 700;
      font-size: 13px;
      background: var(--color-accent);
    }

    .pillRow {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .pill {
      font-size: 13px;
      padding: 7px 10px;
      border: 1px solid var(--color-border);
      border-radius: 999px;
      color: var(--color-text-secondary);
      background: rgba(26,115,232,0.03);
      white-space: nowrap;
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
      background: rgba(26,115,232,0.06);
      border: 1px solid rgba(26,115,232,0.18);
      padding: 2px 6px;
      border-radius: 6px;
      display: inline-block;
    }

    .status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      font-weight: 700;
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid var(--color-border);
      background: var(--color-bg);
      color: var(--color-text-secondary);
      white-space: nowrap;
    }

    .statusDot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: var(--color-text-tertiary);
    }

    .status.implemented { border-color: rgba(52,168,83,0.35); background: rgba(52,168,83,0.06); color: #1f6c37; }
    .status.implemented .statusDot { background: var(--color-success); }

    .status.inprogress { border-color: rgba(249,171,0,0.45); background: rgba(249,171,0,0.08); color: #6c4d00; }
    .status.inprogress .statusDot { background: var(--color-warning); }

    .status.hypothesis { border-color: rgba(26,115,232,0.25); background: rgba(26,115,232,0.06); color: #1a73e8; }
    .status.hypothesis .statusDot { background: var(--color-accent); }

    .status.research { border-color: rgba(95,99,104,0.25); background: rgba(95,99,104,0.05); color: #3b3f45; }
    .status.research .statusDot { background: #80868b; }

    .flow {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 18px 0;
      flex-wrap: wrap;
    }

    .flow-step {
      background: var(--color-bg);
      border: 2px solid var(--color-accent);
      border-radius: 10px;
      padding: 14px 16px;
      font-size: 14px;
      font-weight: 600;
      text-align: center;
      min-width: 160px;
    }

    .flow-step.data { border-color: #7a64ff; background: rgba(122,100,255,0.06); }
    .flow-step.policy { border-color: var(--color-warning); background: rgba(249,171,0,0.08); }
    .flow-step.ops { border-color: var(--color-success); background: rgba(52,168,83,0.06); }

    .flow-arrow {
      font-size: 22px;
      color: var(--color-text-tertiary);
      user-select: none;
    }

    .diagram {
      margin: 18px 0;
      padding: 18px;
      background: var(--color-bg);
      border-radius: 10px;
      border: 1px solid var(--color-border);
    }

    .callout {
      background: rgba(249,171,0,0.08);
      border-left: 4px solid var(--color-warning);
      padding: 16px;
      margin: 16px 0;
      border-radius: 8px;
    }

    .calloutTitle {
      font-weight: 700;
      margin-bottom: 8px;
      color: #402f00;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .cost-table {
      width: 100%;
      border-collapse: collapse;
      margin: 16px 0;
      font-size: 14px;
    }

    .cost-table th {
      background: var(--color-bg);
      padding: 10px 12px;
      text-align: left;
      font-weight: 700;
      border-bottom: 2px solid var(--color-border);
    }

    .cost-table td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--color-border);
      vertical-align: top;
    }

    .grid2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 10px;
    }

    @media (max-width: 920px) {
      .grid2 { grid-template-columns: 1fr; }
    }

    .cardMini {
      border: 1px solid var(--color-border);
      border-radius: 12px;
      padding: 14px;
      background: var(--color-bg);
    }

    .cardMiniTitle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 6px;
      font-weight: 700;
    }

    .list { margin-left: 18px; margin-bottom: 0; }
    .list li { margin-bottom: 6px; }

    /* Mobile */
    @media (max-width: 768px) {
      body { padding: 20px 12px; }
      h1 { font-size: 24px; }
      .subtitle { font-size: 14px; }
      .section { padding: 20px 16px; }
      h2 { font-size: 20px; }

      .flow { flex-direction: column; align-items: stretch; }
      .flow-step { min-width: auto; width: 100%; }
      .flow-arrow { transform: rotate(90deg); margin: 0; }

      .cost-table { font-size: 13px; display: block; overflow-x: auto; }
      .cost-table thead { display: none; }
      .cost-table tr { display: block; margin-bottom: 16px; background: var(--color-bg); border-radius: 10px; padding: 12px; }
      .cost-table td { display: block; padding: 6px 0; border: none; }
      .cost-table td:first-child { font-weight: 700; font-size: 14px; margin-bottom: 8px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>AgentIQ Documentation Portal</h1>
    <p class="subtitle">
      Единая “карта проекта”: модули, продукты внутри продукта, ссылки на документацию и пометки статуса
      (<span class="mono">реализовано</span> / <span class="mono">в процессе</span> / <span class="mono">гипотеза</span>).
    </p>
    <div class="meta">Last updated: 2026-02-17 • Folder: <span class="mono">docs/</span></div>

    <div class="section" id="legend">
      <h2><span class="badge">1</span> Как читать статусы</h2>
      <p>В документации ниже мы явно помечаем: что уже работает в коде, что в разработке, а что пока гипотеза/план.</p>
      <div class="pillRow">
        <div class="status implemented"><span class="statusDot"></span>Реализовано</div>
        <div class="status inprogress"><span class="statusDot"></span>В процессе</div>
        <div class="status hypothesis"><span class="statusDot"></span>Идея / гипотеза / план</div>
        <div class="status research"><span class="statusDot"></span>Исследование / методика</div>
      </div>

      <div class="callout">
        <div class="calloutTitle">Правило “истины”</div>
        Если есть расхождение между документом и кодом, “истина” в:
        <span class="mono">docs/product/UNIFIED_COMM_PLAN_V3_WB_FIRST.md</span> (execution log) и в коде
        <span class="mono">apps/**</span>.
      </div>

      <div class="pillRow">
        <a class="pill" href="./INDEX.md">Docs index (MD)</a>
        <a class="pill" href="./PROJECT_MAP.md">Project map (MD)</a>
        <a class="pill" href="./chat-center/INDEX.md">Chat Center docs</a>
        <a class="pill" href="./reviews/README.md">Reviews docs</a>
      </div>
    </div>

    <div class="section" id="map">
      <h2><span class="badge">2</span> Карта продукта (1 экран, без технарщины)</h2>
      <p>
        AgentIQ сейчас это suite из двух контуров: основной workspace <span class="mono">agentiq.ru/app</span> (chat-center) и legacy отчеты (reviews).
        Траектория: тянуть reviews/questions/chats в единый inbox.
      </p>

      <div class="diagram">
        <p style="font-weight:600; margin-bottom:12px;">5-Layer Architecture (<a href="./architecture/architecture.md">architecture.md</a>)</p>
        <div class="flow">
          <div class="flow-step">1. Ingestion<br><span style="font-size:11px;font-weight:400;color:var(--color-text-secondary)">WB / Ozon / [email]<br>95% ready</span></div>
          <div class="flow-arrow">&rarr;</div>
          <div class="flow-step data">2. Context<br><span style="font-size:11px;font-weight:400;color:var(--color-text-secondary)">Linking, timeline<br>40% ready</span></div>
          <div class="flow-arrow">&rarr;</div>
          <div class="flow-step policy">3. Orchestration<br><span style="font-size:11px;font-weight:400;color:var(--color-text-secondary)">Priority, SLA<br>80% ready</span></div>
          <div class="flow-arrow">&rarr;</div>
          <div class="flow-step data">4. Intelligence<br><span style="font-size:11px;font-weight:400;color:var(--color-text-secondary)">AI + Guardrails<br>80% ready</span></div>
          <div class="flow-arrow">&rarr;</div>
          <div class="flow-step ops">5. Analytics<br><span style="font-size:11px;font-weight:400;color:var(--color-text-secondary)">Quality, Ops<br>85% ready</span></div>
        </div>
        <p style="font-size:13px; color:var(--color-text-secondary); margin-top:12px;">
          Принцип: новый канал = новый коннектор. <span class="mono">Interaction</span> — channel-agnostic модель, все каналы сходятся в одну таблицу.
        </p>
        <p style="font-size:13px; margin-top:8px;">
          Масштабирование: <a href="./architecture/SCALING_NOTES.md">SCALING_NOTES.md</a> — inline AI analysis, tiered scaling (MVP &rarr; enterprise)
        </p>
      </div>

      <div class="grid2">
        <div class="cardMini">
          <div class="cardMiniTitle">
            <span>Workspace: Messages</span>
            <span class="status implemented"><span class="statusDot"></span>Реализовано</span>
          </div>
          <ul class="list">
            <li>Единый список обращений: отзывы, вопросы, чаты</li>
            <li>AI draft для ответов</li>
            <li>Timeline: связка обращений по заказу/покупателю/товару</li>
          </ul>
          <p style="margin-top: 10px; margin-bottom: 0;">
            Док: <a href="./product/UNIFIED_COMM_PLAN_V3_WB_FIRST.md">UNIFIED_COMM_PLAN_V3_WB_FIRST.md</a>
          </p>
        </div>
        <div class="cardMini">
          <div class="cardMiniTitle">
            <span>Workspace: Analytics</span>
            <span class="status implemented"><span class="statusDot"></span>Реализовано</span>
          </div>
          <ul class="list">
            <li>Качество: accepted/edited/manual</li>
            <li>Ops alerts: SLA overdue, regressions</li>
            <li>Readiness gate для пилота</li>
          </ul>
          <p style="margin-top: 10px; margin-bottom: 0;">
            Док: <a href="./chat-center/SCENARIO_ENGINE.md">SCENARIO_ENGINE.md</a>
          </p>
        </div>
      </div>
    </div>

    <div class="section" id="modules">
      <h2><span class="badge">3</span> Модули (код и ответственность)</h2>

      <table class="cost-table">
        <thead>
          <tr>
            <th>Модуль</th>
            <th>Где в репо</th>
            <th>Что делает</th>
            <th>Статус</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>Chat Center / Unified Inbox</strong></td>
            <td><span class="mono">apps/chat-center</span></td>
            <td>
              Основной продукт <span class="mono">agentiq.ru/app</span>. Unified inbox на базе сущности <span class="mono">Interaction</span>.
              Sync + draft + reply + metrics.
            </td>
            <td><span class="status implemented"><span class="statusDot"></span>Реализовано</span></td>
          </tr>
          <tr>
            <td><strong>Reviews Reports (legacy)</strong></td>
            <td><span class="mono">apps/reviews</span></td>
            <td>
              Отдельные отчеты по отзывам + коммуникации (WBCON pipeline, PDF). Используется как “второй продукт” и источник методик.
            </td>
            <td><span class="status implemented"><span class="statusDot"></span>Реализовано</span></td>
          </tr>
          <tr>
            <td><strong>Billing module</strong></td>
            <td><span class="mono">docs/BILLING_ARCHITECTURE.md</span></td>
            <td>Дизайн биллинга и feature gating.</td>
            <td><span class="status hypothesis"><span class="statusDot"></span>План</span></td>
          </tr>
          <tr>
            <td><strong>2.0 Vision</strong></td>
            <td><span class="mono">docs/architecture/AGENTIQ_2.0_ARCHITECTURE.md</span></td>
            <td>Визионерская архитектура (направление, не текущая реальность).</td>
            <td><span class="status hypothesis"><span class="statusDot"></span>Гипотеза</span></td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="section" id="chatcenter">
      <h2><span class="badge">4</span> Что внутри Chat Center (подсистемы)</h2>
      <p>Ниже подсистемы, чтобы понимать архитектуру без чтения всего кода.</p>

      <div class="grid2">
        <div class="cardMini">
          <div class="cardMiniTitle">
            <span>Interaction Layer (unified)</span>
            <span class="status implemented"><span class="statusDot"></span>Реализовано</span>
          </div>
          <p class="subtitle" style="margin-bottom: 8px;">
            Unified сущность <span class="mono">Interaction</span> и <span class="mono">InteractionEvent</span>, единые endpoints для list/sync/draft/reply/metrics.
          </p>
          <ul class="list">
            <li>API: <span class="mono">backend/app/api/interactions.py</span></li>
            <li>Models: <span class="mono">backend/app/models/interaction*.py</span></li>
            <li>Docs: <a href="./product/UNIFIED_COMM_PLAN_V3_WB_FIRST.md">UNIFIED_COMM_PLAN_V3_WB_FIRST.md</a></li>
          </ul>
        </div>

        <div class="cardMini">
          <div class="cardMiniTitle">
            <span>Ingestion (WB reviews/questions/chats)</span>
            <span class="status implemented"><span class="statusDot"></span>Реализовано</span>
          </div>
          <p class="subtitle" style="margin-bottom: 8px;">
            Фоновая синхронизация и ручные sync endpoints, нормализация в interactions.
          </p>
          <ul class="list">
            <li>Service: <span class="mono">backend/app/services/interaction_ingest.py</span></li>
            <li>Connectors: <span class="mono">wb_*_connector.py</span></li>
            <li>Docs: <a href="./chat-center/WB_CHAT_API_RESEARCH.md">WB_CHAT_API_RESEARCH.md</a></li>
          </ul>
        </div>

        <div class="cardMini">
          <div class="cardMiniTitle">
            <span>Linking + Timeline</span>
            <span class="status implemented"><span class="statusDot"></span>Реализовано</span>
          </div>
          <p class="subtitle" style="margin-bottom: 8px;">
            Детерминированные и вероятностные связки, policy “auto vs assist-only”.
          </p>
          <ul class="list">
            <li>Service: <span class="mono">backend/app/services/interaction_linking.py</span></li>
            <li>UI: “timeline” в правой панели</li>
          </ul>
        </div>

        <div class="cardMini">
          <div class="cardMiniTitle">
            <span>AI Drafting</span>
            <span class="status implemented"><span class="statusDot"></span>Реализовано</span>
          </div>
          <p class="subtitle" style="margin-bottom: 8px;">
            LLM draft + fallback, runtime switch модели через БД.
          </p>
          <ul class="list">
            <li>Service: <span class="mono">backend/app/services/interaction_drafts.py</span></li>
            <li>Runtime: <span class="mono">backend/app/services/llm_runtime.py</span></li>
          </ul>
        </div>

        <div class="cardMini">
          <div class="cardMiniTitle">
            <span>Metrics / Ops alerts / Readiness</span>
            <span class="status implemented"><span class="statusDot"></span>Реализовано</span>
          </div>
          <p class="subtitle" style="margin-bottom: 8px;">
            События воронки draft→reply, ops alerts, GO/NO-GO readiness.
          </p>
          <ul class="list">
            <li>Service: <span class="mono">backend/app/services/interaction_metrics.py</span></li>
            <li>Docs: <a href="./product/PILOT_QA_MATRIX_AND_GONOGO_CHECKLIST.md">PILOT_QA_MATRIX...</a></li>
          </ul>
        </div>

        <div class="cardMini">
          <div class="cardMiniTitle">
            <span>Scenario Engine (policy + guardrails)</span>
            <span class="status inprogress"><span class="statusDot"></span>В процессе</span>
          </div>
          <p class="subtitle" style="margin-bottom: 8px;">
            Сценарная оркестрация P0-P3 поверх unified слоя. Сейчас описано и частично реализовано как policy в слоях linking/metrics;
            дальше нужно формализовать <span class="mono">ScenarioDefinition</span> и <span class="mono">ScenarioRun</span>.
          </p>
          <ul class="list">
            <li>Docs: <a href="./chat-center/scenario-engine.html">scenario-engine.html</a></li>
            <li>Tech doc: <a href="./chat-center/SCENARIO_ENGINE.md">SCENARIO_ENGINE.md</a></li>
            <li>Compliance: <a href="./research/06-wb-chat-consent-and-crm-triggers-2026.md">WB chat consent</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="section" id="guardrails">
      <h2><span class="badge">5</span> Guardrails System</h2>
      <p>
        Guardrails — декларативная этическая и операционная система. Минимум хардкода: правила описаны как таблицы, категории и пороги.
        Код читает конфиги и применяет правила обобщённо. Новое правило = строка в таблице, не новая ветка кода.
      </p>

      <div class="callout">
        <div class="calloutTitle">Единый источник</div>
        <a href="./GUARDRAILS.md"><strong>docs/GUARDRAILS.md</strong></a> — консолидированная документация.
        Заменяет разрозненные правила из guardrails.py, interaction_linking.py, llm_analyzer.py, RESPONSE_GUARDRAILS.md.
      </div>

      <p style="margin-top: 16px; font-weight: 600;">Pipeline (4 этапа):</p>
      <div class="flow">
        <div class="flow-step">Content<br><span style="font-size:12px;font-weight:400;color:var(--color-text-secondary)">Banned phrases, длина, тон</span></div>
        <div class="flow-arrow">&rarr;</div>
        <div class="flow-step policy">Safety Policies<br><span style="font-size:12px;font-weight:400;color:#6c4d00">A: False Authority<br>B: WB Moderation<br>C: Legal Admissions</span></div>
        <div class="flow-arrow">&rarr;</div>
        <div class="flow-step data">Action Policy<br><span style="font-size:12px;font-weight:400;color:var(--color-text-secondary)">auto vs assist-only<br>confidence &ge; 0.85</span></div>
        <div class="flow-arrow">&rarr;</div>
        <div class="flow-step ops">Audit Trail<br><span style="font-size:12px;font-weight:400;color:var(--color-text-secondary)">violations, warnings,<br>policy_version</span></div>
      </div>

      <div class="grid2" style="margin-top: 16px;">
        <div class="cardMini">
          <div class="cardMiniTitle">
            <span>Content Guardrails</span>
            <span class="status implemented"><span class="statusDot"></span>Реализовано</span>
          </div>
          <ul class="list">
            <li>4 категории banned phrases: ai_mention, promises, blame, dismissive</li>
            <li>Канальные правила: review/question (strict) vs chat (relaxed)</li>
            <li>Условная логика возвратов: trigger-based (public) + intent-based (chat)</li>
          </ul>
          <p style="margin-top: 8px; margin-bottom: 0;">
            Code: <a href="../apps/chat-center/backend/app/services/guardrails.py"><span class="mono">guardrails.py</span></a>
          </p>
        </div>
        <div class="cardMini">
          <div class="cardMiniTitle">
            <span>Action Policy (Auto-Action)</span>
            <span class="status implemented"><span class="statusDot"></span>Реализовано</span>
          </div>
          <ul class="list">
            <li>Deterministic link + confidence &ge; 0.85 &rarr; auto-action allowed</li>
            <li>Deterministic link + confidence &lt; 0.85 &rarr; assist-only</li>
            <li>Probabilistic link (any confidence) &rarr; always assist-only</li>
          </ul>
          <p style="margin-top: 8px; margin-bottom: 0;">
            Code: <a href="../apps/chat-center/backend/app/services/interaction_linking.py"><span class="mono">interaction_linking.py</span></a>
          </p>
        </div>
        <div class="cardMini">
          <div class="cardMiniTitle">
            <span>Safety Policies (3 группы)</span>
            <span class="status implemented"><span class="statusDot"></span>Реализовано</span>
          </div>
          <ul class="list">
            <li><strong>A:</strong> False Authority — не обещать то, что не контролируешь</li>
            <li><strong>B:</strong> WB Moderation — не раскрывать AI, не уводить с площадки</li>
            <li><strong>C:</strong> Legal Admissions — не признавать вину/дефект/контрафакт</li>
          </ul>
        </div>
        <div class="cardMini">
          <div class="cardMiniTitle">
            <span>Escalation Rules</span>
            <span class="status implemented"><span class="statusDot"></span>Реализовано</span>
          </div>
          <ul class="list">
            <li>Аллергия / здоровье &rarr; STOP, менеджеру</li>
            <li>Контрафакт / юр. угрозы &rarr; STOP, юристу</li>
            <li>Массовый дефект / PII &rarr; FLAG + эскалация</li>
          </ul>
        </div>
      </div>

      <div class="pillRow" style="margin-top: 12px;">
        <a class="pill" href="./GUARDRAILS.md">GUARDRAILS.md (единый док)</a>
        <a class="pill" href="./reviews/RESPONSE_GUARDRAILS.md">Legacy: RESPONSE_GUARDRAILS.md</a>
        <a class="pill" href="./specs/guardrails/AI_DRAFTS.md">Spec: AI Drafts</a>
        <a class="pill" href="./specs/guardrails/REVIEWS_RESPONSES.md">Spec: Reviews</a>
        <a class="pill" href="./specs/guardrails/CHAT_RESPONSES.md">Spec: Chat</a>
      </div>
    </div>

    <div class="section" id="ai-draft">
      <h2><span class="badge">6</span> AI Draft Generation Flow</h2>
      <p>
        Генерация AI-драфтов — критичный этап в обработке обращений. Текущая имплементация работает on-demand (4-5s задержка),
        планируется переход на pre-generation в фоновом режиме (instant UX).
      </p>

      <h3>Current Flow (On-Demand Generation)</h3>
      <div class="diagram">
        <p style="font-weight:600; margin-bottom:12px;">Полный цикл генерации драфта при открытии взаимодействия</p>
        <div class="flow">
          <div class="flow-step">User opens interaction</div>
          <div class="flow-arrow">→</div>
          <div class="flow-step data">Check last_ai_draft cache</div>
        </div>
        <div class="flow" style="margin-top: 8px;">
          <div class="flow-step ops">HIT: show instantly<br><span style="font-size:11px;font-weight:400;color:var(--color-text-secondary)">~0ms</span></div>
        </div>
        <div class="flow" style="margin-top: 8px;">
          <div class="flow-step policy">MISS: POST /ai-draft</div>
          <div class="flow-arrow">→</div>
          <div class="flow-step data">1. Fetch product card<br><span style="font-size:11px;font-weight:400;color:var(--color-text-secondary)">WB CDN, ~200ms, cached 1h</span></div>
          <div class="flow-arrow">→</div>
          <div class="flow-step data">2. Read seller tone<br><span style="font-size:11px;font-weight:400;color:var(--color-text-secondary)">DB, ~5ms</span></div>
        </div>
        <div class="flow" style="margin-top: 8px;">
          <div class="flow-step data">3. Build channel prompt<br><span style="font-size:11px;font-weight:400;color:var(--color-text-secondary)">~1ms</span></div>
          <div class="flow-arrow">→</div>
          <div class="flow-step policy">4. DeepSeek LLM API<br><span style="font-size:11px;font-weight:400;color:#6c4d00">~3-4s ★bottleneck★</span></div>
          <div class="flow-arrow">→</div>
          <div class="flow-step data">5. Apply guardrails<br><span style="font-size:11px;font-weight:400;color:var(--color-text-secondary)">~1ms</span></div>
        </div>
        <div class="flow" style="margin-top: 8px;">
          <div class="flow-step ops">6. Save to metadata<br><span style="font-size:11px;font-weight:400;color:var(--color-text-secondary)">DB, ~10ms</span></div>
          <div class="flow-arrow">→</div>
          <div class="flow-step ops">Total: ~4-5s</div>
        </div>
      </div>

      <h3>Speed Breakdown Table</h3>
      <table class="cost-table">
        <thead>
          <tr>
            <th>Step</th>
            <th>Time</th>
            <th>Caching</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>Product card fetch</strong></td>
            <td>~200ms</td>
            <td><span class="status implemented"><span class="statusDot"></span>1h cache</span></td>
            <td>WB CDN API, hit rate ~85% после разогрева</td>
          </tr>
          <tr>
            <td><strong>Seller tone read</strong></td>
            <td>~5ms</td>
            <td><span class="status implemented"><span class="statusDot"></span>SQLAlchemy cache</span></td>
            <td>DB query, negligible</td>
          </tr>
          <tr>
            <td><strong>Build prompt</strong></td>
            <td>~1ms</td>
            <td>—</td>
            <td>Channel-specific prompt template</td>
          </tr>
          <tr>
            <td><strong>DeepSeek LLM call</strong></td>
            <td style="color: var(--color-warning); font-weight: 700;">~3-4s</td>
            <td><span class="status hypothesis"><span class="statusDot"></span>No cache</span></td>
            <td>★ Основной bottleneck ★ Network + generation latency</td>
          </tr>
          <tr>
            <td><strong>Guardrails validation</strong></td>
            <td>~1ms</td>
            <td>—</td>
            <td>Regex + policy checks</td>
          </tr>
          <tr>
            <td><strong>Save to metadata</strong></td>
            <td>~10ms</td>
            <td>—</td>
            <td>UPDATE interaction.metadata</td>
          </tr>
          <tr style="background: rgba(26,115,232,0.06);">
            <td colspan="4" style="text-align: center; font-weight: 700;">Total (cold): ~4-5s | Total (cached product): ~3.5s</td>
          </tr>
        </tbody>
      </table>

      <h3>Future Flow (Pre-Generation at Sync Time)</h3>
      <div class="diagram">
        <p style="font-weight:600; margin-bottom:12px;">Background pre-generation для instant UX</p>
        <div class="flow">
          <div class="flow-step data">Sync cycle fetches<br>new interactions</div>
          <div class="flow-arrow">→</div>
          <div class="flow-step policy">Background worker<br>generates drafts</div>
          <div class="flow-arrow">→</div>
          <div class="flow-step ops">User opens interaction</div>
          <div class="flow-arrow">→</div>
          <div class="flow-step ops">Draft already cached</div>
          <div class="flow-arrow">→</div>
          <div class="flow-step ops">Show instantly (0ms)</div>
        </div>
        <div class="callout" style="margin-top: 16px;">
          <div class="calloutTitle">Fallback</div>
          Если для взаимодействия нет pre-generated draft → откат на on-demand generation (~4-5s). Гарантирует 100% доступность драфтов.
        </div>
      </div>

      <h3>Channel-Specific Prompts</h3>
      <div class="grid2">
        <div class="cardMini">
          <div class="cardMiniTitle">
            <span>Reviews (strict)</span>
            <span class="status implemented"><span class="statusDot"></span>Реализовано</span>
          </div>
          <ul class="list">
            <li>Публичная площадка → strict guardrails</li>
            <li>Banned: AI mentions, promises, dismissive tone</li>
            <li>Возврат/замена ТОЛЬКО если покупатель явно попросил</li>
            <li>Tone: formal, empathetic, brand-safe</li>
          </ul>
        </div>
        <div class="cardMini">
          <div class="cardMiniTitle">
            <span>Questions (strict)</span>
            <span class="status implemented"><span class="statusDot"></span>Реализовано</span>
          </div>
          <ul class="list">
            <li>Публичная площадка → strict guardrails</li>
            <li>Pre-purchase: sizing, availability, compatibility</li>
            <li>Crisp answers, product specs, no fluff</li>
            <li>SLA: &lt;5 мин (high priority для pre-purchase)</li>
          </ul>
        </div>
        <div class="cardMini">
          <div class="cardMiniTitle">
            <span>Chats (relaxed)</span>
            <span class="status implemented"><span class="statusDot"></span>Реализовано</span>
          </div>
          <ul class="list">
            <li>Приватный канал → relaxed guardrails</li>
            <li>Intent-based return offers (allowed in chat)</li>
            <li>Conversational tone, iterative problem solving</li>
            <li>Timeline context: previous messages, linked order</li>
          </ul>
        </div>
      </div>

      <div class="pillRow" style="margin-top: 16px;">
        <a class="pill" href="./product/AI_DRAFT_QUALITY_PLAN.md">AI Draft Quality Plan</a>
        <a class="pill" href="./product/PRE_GENERATE_AI_DRAFTS_PLAN.md">Pre-Generation Plan</a>
        <a class="pill" href="../apps/chat-center/backend/app/services/interaction_drafts.py">Code: interaction_drafts.py</a>
        <a class="pill" href="./GUARDRAILS.md">Guardrails (Content + Safety)</a>
      </div>
    </div>

    <div class="section" id="lifecycle">
      <h2><span class="badge">7</span> Communication Strategy (Realistic)</h2>
      <p>
        AI-ассистент для идеальной реакции на обращения клиентов на WB/Ozon.
        <strong>Фокус: Product Quality + Response Excellence</strong>, не lifecycle marketing (т.к. нет истории покупок/email/проактивных кампаний).
      </p>

      <div class="callout">
        <div class="calloutTitle">⚠️ Ограничения маркетплейсов + Платные возможности</div>
        <p style="margin-bottom: 12px;">WB/Ozon <strong>НЕ дают</strong> историю покупок клиентов, email/телефоны. <strong>НО:</strong> платная опция WB позволяет писать в чат при ЛЮБОМ отзыве (включая 5★).</p>
        <p style="font-weight: 600; margin-bottom: 8px;">Что можем:</p>
        <ul class="list">
          <li><strong>+20%</strong> конверсия вопрос→покупка при ответе &lt;1h (реактивный)</li>
          <li><strong>40-60%</strong> win rate спасения 1★→4-5★ через платный чат WB</li>
          <li><strong>14%</strong> upsell conversion на 5★ через платный чат WB</li>
          <li><strong>Product Quality Alerts</strong> — рост негатива >30% → alert менеджеру</li>
          <li><strong>Fuzzy Linking</strong> — связка чатов/отзывов по clientID</li>
        </ul>
      </div>

      <div class="grid2" style="margin-top: 20px;">
        <div class="cardMini">
          <div class="cardMiniTitle">
            <span>Interactive Dashboard (UI Prototype)</span>
            <span class="status implemented"><span class="statusDot"></span>Готово</span>
          </div>
          <p class="subtitle" style="margin-bottom: 8px;">
            Интерактивный прототип Dashboard для управления реактивными сценариями (с учётом ограничений WB/Ozon API).
          </p>
          <ul class="list">
            <li>Live метрики: Upsell Conversion, Win Rate, ROI</li>
            <li>8 реалистичных scenario cards (включая Upsell 5★ платный)</li>
            <li>Product-level analytics + платные фичи WB</li>
            <li>Fuzzy linking через clientID</li>
            <li>Automation settings (включая платный upsell)</li>
          </ul>
          <p style="margin-top: 10px; margin-bottom: 0;">
            <a href="../pages/lifecycle-dashboard.html"><strong>Открыть Dashboard →</strong></a>
          </p>
        </div>

        <div class="cardMini">
          <div class="cardMiniTitle">
            <span>Detailed Scenarios (Documentation)</span>
            <span class="status implemented"><span class="statusDot"></span>Готово</span>
          </div>
          <p class="subtitle" style="margin-bottom: 8px;">
            Подробная документация реалистичных сценариев с учётом ограничений маркетплейсов (нет истории покупок, email, проактивных кампаний).
          </p>
          <ul class="list">
            <li>Ограничения API + платные возможности WB</li>
            <li>6 реалистичных сценариев (включая Upsell 5★)</li>
            <li>Product-centric подход + платные фичи</li>
            <li>Generic upsell (нет персонализации по истории)</li>
            <li>Честный питч: Response Excellence + Paid Features</li>
          </ul>
          <p style="margin-top: 10px; margin-bottom: 0;">
            <a href="../pages/scenarios.html"><strong>Читать документацию →</strong></a>
          </p>
        </div>
      </div>

      <h3 style="margin-top: 24px;">Сценарии (краткая справка)</h3>
      <table class="cost-table">
        <thead>
          <tr>
            <th>Сценарий</th>
            <th>Приоритет</th>
            <th>Метрики</th>
            <th>ROI</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>Спасение негатива (1-2★)</strong></td>
            <td><span class="status" style="border-color: rgba(234,67,53,0.45); background: rgba(234,67,53,0.08); color: #8e1b0f;"><span class="statusDot" style="background: var(--color-danger);"></span>CRITICAL</span></td>
            <td>58% win rate, 23 спасено/мес</td>
            <td>2.8x</td>
          </tr>
          <tr>
            <td><strong>Вопрос → Конверсия (&lt;1h)</strong></td>
            <td><span class="status" style="border-color: rgba(234,67,53,0.45); background: rgba(234,67,53,0.08); color: #8e1b0f;"><span class="statusDot" style="background: var(--color-danger);"></span>CRITICAL</span></td>
            <td>32% конверсия, 18 мин avg время</td>
            <td>∞ (бесплатно)</td>
          </tr>
          <tr>
            <td><strong>Churn Prevention</strong></td>
            <td><span class="status" style="border-color: rgba(234,67,53,0.45); background: rgba(234,67,53,0.08); color: #8e1b0f;"><span class="statusDot" style="background: var(--color-danger);"></span>CRITICAL</span></td>
            <td>45% prevention, 2.1k₽ avg сохранено</td>
            <td>14x</td>
          </tr>
          <tr>
            <td><strong>Upsell на 5★ (платный чат WB)</strong></td>
            <td><span class="status" style="border-color: rgba(52,168,83,0.35); background: rgba(52,168,83,0.06); color: #1f6c37;"><span class="statusDot" style="background: var(--color-success);"></span>HIGH ROI</span></td>
            <td>14% конверсия, +1.2k₽ AOV (платная опция WB)</td>
            <td>6.8x</td>
          </tr>
          <tr>
            <td><strong>Апгрейд 3★ → 5★</strong></td>
            <td><span class="status" style="border-color: rgba(52,168,83,0.35); background: rgba(52,168,83,0.06); color: #1f6c37;"><span class="statusDot" style="background: var(--color-success);"></span>HIGH ROI</span></td>
            <td>28% upgrade, 42% repeat purchase</td>
            <td>6.2x</td>
          </tr>
          <tr>
            <td><strong>Product Quality Alert</strong></td>
            <td><span class="status" style="border-color: rgba(249,171,0,0.45); background: rgba(249,171,0,0.08); color: #6c4d00;"><span class="statusDot" style="background: var(--color-warning);"></span>PRODUCT-LEVEL</span></td>
            <td>12 alerts/мес, 85% prevented</td>
            <td>— (внутренний)</td>
          </tr>
          <tr>
            <td><strong>Sizing/Fit FAQ Auto</strong></td>
            <td><span class="status" style="border-color: rgba(249,171,0,0.45); background: rgba(249,171,0,0.08); color: #6c4d00;"><span class="statusDot" style="background: var(--color-warning);"></span>PRODUCT-LEVEL</span></td>
            <td>18% конверсия, 2.3 мин avg</td>
            <td>5.1x</td>
          </tr>
        </tbody>
      </table>

      <div class="pillRow" style="margin-top: 16px;">
        <a class="pill" href="../pages/index.html">Главная страница</a>
        <a class="pill" href="../pages/lifecycle-dashboard.html">Dashboard (UI prototype)</a>
        <a class="pill" href="../pages/scenarios.html">Scenarios (documentation)</a>
        <a class="pill" href="../pages/README.md">README (setup guide)</a>
      </div>
    </div>

    <div class="section" id="docs">
      <h2><span class="badge">8</span> Навигация по документации (ссылки + статус)</h2>

      <h3>Product</h3>
      <ul class="list">
        <li><a href="./product/PRODUCT.md">product/PRODUCT.md</a> <span class="status implemented"><span class="statusDot"></span>Реализовано</span></li>
        <li><a href="./product/BACKLOG.md"><strong>product/BACKLOG.md</strong></a> <span class="status implemented"><span class="statusDot"></span>Единый бэклог (demo / MVP / roadmap)</span></li>
        <li><a href="./product/UNIFIED_COMM_PLAN_V3_WB_FIRST.md">product/UNIFIED_COMM_PLAN_V3_WB_FIRST.md</a> <span class="status implemented"><span class="statusDot"></span>Execution log</span></li>
        <li><a href="./product/BACKLOG_UNIFIED_COMM_V3.md">product/BACKLOG_UNIFIED_COMM_V3.md</a> <span class="status research"><span class="statusDot"></span>Legacy (detail per task)</span></li>
      </ul>

      <h3>Chat Center</h3>
      <ul class="list">
        <li><a href="./chat-center/INDEX.md">chat-center/INDEX.md</a> <span class="status implemented"><span class="statusDot"></span>Реализовано</span></li>
        <li><a href="./chat-center/QUICKSTART.md">chat-center/QUICKSTART.md</a> <span class="status implemented"><span class="statusDot"></span>Реализовано</span></li>
        <li><a href="./chat-center/SCENARIO_ENGINE.md">chat-center/SCENARIO_ENGINE.md</a> <span class="status implemented"><span class="statusDot"></span>Реализовано</span></li>
        <li><a href="./chat-center/scenario-engine.html">chat-center/scenario-engine.html</a> <span class="status implemented"><span class="statusDot"></span>Реализовано</span></li>
        <li><a href="./chat-center/LOADING_ARCHITECTURE.md">chat-center/LOADING_ARCHITECTURE.md</a> — загрузка, кэш, пагинация, мировая практика <span class="status implemented"><span class="statusDot"></span>Реализовано</span></li>
      </ul>

      <h3>Reviews (legacy)</h3>
      <ul class="list">
        <li><a href="./reviews/README.md">reviews/README.md</a> <span class="status implemented"><span class="statusDot"></span>Реализовано</span></li>
        <li><a href="./reviews/PROJECT_SUMMARY.md">reviews/PROJECT_SUMMARY.md</a> <span class="status implemented"><span class="statusDot"></span>Реализовано</span></li>
        <li><a href="./reviews/RESPONSE_GUARDRAILS.md">reviews/RESPONSE_GUARDRAILS.md</a> <span class="status research"><span class="statusDot"></span>Legacy (see GUARDRAILS.md)</span></li>
      </ul>

      <h3>Guardrails</h3>
      <ul class="list">
        <li><a href="./GUARDRAILS.md">GUARDRAILS.md</a> <span class="status implemented"><span class="statusDot"></span>Реализовано</span></li>
        <li><a href="./specs/guardrails/AI_DRAFTS.md">specs/guardrails/AI_DRAFTS.md</a> <span class="status hypothesis"><span class="statusDot"></span>Draft</span></li>
        <li><a href="./specs/guardrails/REVIEWS_RESPONSES.md">specs/guardrails/REVIEWS_RESPONSES.md</a> <span class="status hypothesis"><span class="statusDot"></span>Draft</span></li>
        <li><a href="./specs/guardrails/CHAT_RESPONSES.md">specs/guardrails/CHAT_RESPONSES.md</a> <span class="status hypothesis"><span class="statusDot"></span>Draft</span></li>
      </ul>

      <h3>Architecture</h3>
      <ul class="list">
        <li><a href="./architecture/architecture.md">architecture/architecture.md</a> <span class="status implemented"><span class="statusDot"></span>5-Layer Model + Gap Analysis</span></li>
        <li><a href="./architecture/AGENTIQ_2.0_ARCHITECTURE.md">architecture/AGENTIQ_2.0_ARCHITECTURE.md</a> <span class="status hypothesis"><span class="statusDot"></span>Vision (post-PMF)</span></li>
      </ul>

      <h3>Ops / Research</h3>
      <ul class="list">
        <li><a href="./ops/DEPLOYMENT.md">ops/DEPLOYMENT.md</a> <span class="status implemented"><span class="statusDot"></span>Реализовано</span></li>
        <li><a href="./ops/HARD_PILOT_SLO_RUNBOOK_20260216.md">ops/HARD_PILOT_SLO_RUNBOOK_20260216.md</a> <span class="status implemented"><span class="statusDot"></span>SLO/p95 пороги</span></li>
        <li><a href="./research/INDEX.md">research/INDEX.md</a> <span class="status research"><span class="statusDot"></span>Исследование</span></li>
      </ul>
    </div>

    <div class="section" id="next">
      <h2><span class="badge">9</span> Что дальше (как поддерживать актуальность)</h2>
      <p>
        Чтобы документация не “протухала”, важно ввести простую дисциплину:
      </p>
      <ul class="list">
        <li>В каждом крупном документе в начале: <span class="mono">Last updated</span> и <span class="mono">Status</span>.</li>
        <li>Если это гипотеза: явно писать “это план, не реализовано”.</li>
        <li>Если это реализовано: давать ссылки на “истинные” файлы/эндпоинты/таблицы.</li>
        <li>Execution log держать в <span class="mono">docs/product/UNIFIED_COMM_PLAN_V3_WB_FIRST.md</span>.</li>
      </ul>
      <div class="pillRow">
        <a class="pill" href="../next-actions.md">Roadmap: next-actions.md</a>
        <a class="pill" href="./CHANGELOG.md">Chat Center changelog</a>
        <a class="pill" href="./SLA_RULES.md">SLA rules</a>
        <a class="pill" href="./bugs/%D0%91%D0%90%D0%93%D0%98.md">Bugs/Ideas log</a>
        <a class="pill" href="./bugs/INBOX.md">Raw inbox</a>
      </div>
    </div>
  </div>
</body>
</html>
