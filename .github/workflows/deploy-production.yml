name: Deploy to Production

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      confirm:
        description: 'Type "deploy" to confirm production deployment'
        required: true
        default: ''

jobs:
  validate:
    name: Validate Deployment Request
    runs-on: ubuntu-latest

    steps:
      - name: Check confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "deploy" ]; then
            echo "‚ùå Deployment not confirmed. You must type 'deploy' to proceed."
            exit 1
          fi
          echo "‚úÖ Deployment confirmed"

  quality:
    name: Pre-deploy Quality Gate
    needs: validate
    runs-on: ubuntu-latest

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check docs freshness
        run: python scripts/check-docs-freshness.py

      - name: Install backend dependencies
        run: |
          cd apps/chat-center/backend
          pip install -r requirements.txt

      - name: Run backend tests with coverage
        run: |
          cd apps/chat-center/backend
          pip install pytest-cov
          pytest tests/ -v --tb=short --cov=app --cov-report=term-missing --cov-fail-under=55
        env:
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY || '7JiOr8WP3UdiuX6DDkxsbwdiFNXyYoKxYc_CIci5qJo=' }}
          SECRET_KEY: "ci-test-secret-key-not-for-production"
          DATABASE_URL: "sqlite+aiosqlite:///:memory:"
          REDIS_URL: "redis://localhost:6379/0"

      - name: Install frontend dependencies
        run: |
          cd apps/chat-center/frontend
          npm ci --no-audit --no-fund

      - name: Run frontend lint (non-blocking)
        run: |
          cd apps/chat-center/frontend
          npm run lint || echo "‚ö†Ô∏è Lint issues found ‚Äî see annotations above (non-blocking)"
        continue-on-error: true

      - name: Build frontend
        run: |
          cd apps/chat-center/frontend
          npm run build

      - name: Install Playwright browsers
        run: |
          cd apps/chat-center/frontend
          npx playwright install --with-deps chromium

      - name: Run E2E tests (Playwright)
        run: |
          cd apps/chat-center/frontend
          npx playwright test --project=chromium || echo "‚ö†Ô∏è E2E tests failed (non-blocking for now)"

  backup:
    name: Backup Production Database
    needs: quality
    runs-on: ubuntu-latest

    steps:
      - name: Create database backup
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 79.137.175.164
          username: ubuntu
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "üì¶ Creating database backup..."

            BACKUP_DIR="/opt/backups"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            BACKUP_FILE="$BACKUP_DIR/agentiq_chat_$TIMESTAMP.sql"

            mkdir -p $BACKUP_DIR

            # Dump database
            sudo -u postgres pg_dump agentiq_chat > $BACKUP_FILE

            # Compress
            gzip $BACKUP_FILE

            echo "‚úÖ Backup created: ${BACKUP_FILE}.gz"

            # Keep only last 7 backups
            cd $BACKUP_DIR
            ls -t agentiq_chat_*.sql.gz | tail -n +8 | xargs -r rm

            echo "‚úÖ Old backups cleaned"

  deploy:
    name: Deploy to Production
    needs: backup
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy backend to production
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 79.137.175.164
          username: ubuntu
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "üöÄ Deploying backend to production..."

            cd /opt/agentiq
            git pull origin main

            # Activate venv and install deps
            source venv/bin/activate
            cd backend
            pip install -r requirements.txt

            # Run migrations
            alembic upgrade head

            # Restart backend
            sudo systemctl restart agentiq-chat

            # Restart Celery worker and beat
            sudo systemctl restart agentiq-celery
            sudo systemctl restart agentiq-celery-beat

            echo "‚úÖ Backend deployed"

      - name: Deploy frontend to production
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 79.137.175.164
          username: ubuntu
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "üöÄ Deploying frontend to production..."

            cd /opt/agentiq/frontend

            # Install deps and build
            npm install
            npm run build

            # Rename index.html ‚Üí landing.html (nginx serves landing.html at /)
            mv dist/index.html dist/landing.html

            # Deploy: update landing.html + assets only (preserves docs/, app/ etc.)
            sudo cp dist/landing.html /var/www/agentiq/landing.html
            sudo rm -rf /var/www/agentiq/assets/
            sudo cp -r dist/assets/ /var/www/agentiq/assets/
            # Update app/ SPA if present in build output
            if [ -d dist/app ]; then
              sudo rm -rf /var/www/agentiq/app/
              sudo cp -r dist/app/ /var/www/agentiq/app/
            fi
            sudo chown -R www-data:www-data /var/www/agentiq/landing.html \
              /var/www/agentiq/assets/

            echo "‚úÖ Frontend deployed"

      - name: Copy docs/ to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: 79.137.175.164
          username: ubuntu
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "docs/"
          target: "/tmp/agentiq-docs-deploy"
          strip_components: 0

      - name: Deploy docs to production
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 79.137.175.164
          username: ubuntu
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "üîÑ Syncing docs/ ‚Üí /var/www/agentiq/docs/ ..."
            sudo rsync -a --delete \
              --exclude="*.pyc" \
              --exclude=".DS_Store" \
              /tmp/agentiq-docs-deploy/docs/ \
              /var/www/agentiq/docs/
            sudo cp /var/www/agentiq/docs/docs-home.html /var/www/agentiq/docs-home.html
            sudo chown -R www-data:www-data /var/www/agentiq/docs/ /var/www/agentiq/docs-home.html
            rm -rf /tmp/agentiq-docs-deploy
            echo "‚úÖ $(ls /var/www/agentiq/docs/ | wc -l) —Ñ–∞–π–ª–æ–≤ –≤ /docs/"

      - name: Wait for services to start
        run: sleep 15

      - name: Smoke test production
        id: smoke_test
        run: |
          echo "üß™ Running production smoke tests..."

          # Health check
          HEALTH_RESPONSE=$(curl -s https://agentiq.ru/api/health)
          HEALTH_STATUS=$(echo $HEALTH_RESPONSE | jq -r '.status' 2>/dev/null || echo "error")

          if [ "$HEALTH_STATUS" != "ok" ] && [ "$HEALTH_STATUS" != "healthy" ]; then
            echo "‚ùå Health check failed: $HEALTH_RESPONSE"
            exit 1
          fi

          echo "‚úÖ Backend health check passed"

          # Frontend check
          FRONTEND_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://agentiq.ru/)

          if [ "$FRONTEND_CODE" != "200" ]; then
            echo "‚ùå Frontend check failed (HTTP $FRONTEND_CODE)"
            exit 1
          fi

          echo "‚úÖ Frontend check passed"

          # Critical endpoints
          LOGIN_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://agentiq.ru/api/auth/login -X POST -H "Content-Type: application/json" -d '{}')

          if [ "$LOGIN_CODE" != "422" ] && [ "$LOGIN_CODE" != "400" ]; then
            # 422/400 expected for empty payload, anything else is bad
            echo "‚ùå Login endpoint check failed (HTTP $LOGIN_CODE)"
            exit 1
          fi

          echo "‚úÖ Login endpoint check passed"

          # Docs check
          DOCS_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://agentiq.ru/docs-home.html)
          if [ "$DOCS_CODE" != "200" ]; then
            echo "‚ùå docs-home.html check failed (HTTP $DOCS_CODE)"
            exit 1
          fi
          echo "‚úÖ docs-home.html check passed"

          echo "‚úÖ All smoke tests passed"

      - name: Notify on success
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const commit = await github.rest.repos.getCommit({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: 'main'
            });

            const message = `‚úÖ **Production Deploy Successful**

            **Commit:** ${commit.data.commit.message.split('\n')[0]}
            **Author:** ${commit.data.commit.author.name}
            **SHA:** \`${commit.data.sha.substring(0, 7)}\`
            **Deployed by:** @${context.actor}

            üîó https://agentiq.ru

            All smoke tests passed. Production is live.`;

            // Create deployment issue comment or discussion
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Production Deploy - ${new Date().toISOString().split('T')[0]}`,
              body: message,
              labels: ['deployment', 'production']
            });

      - name: Rollback on failure
        if: steps.smoke_test.outcome == 'failure'
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 79.137.175.164
          username: ubuntu
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "‚ùå Smoke tests failed. Rolling back production..."

            # Rollback backend
            cd /opt/agentiq
            git reset --hard HEAD~1
            source venv/bin/activate
            cd backend
            pip install -r requirements.txt
            sudo systemctl restart agentiq-chat
            sudo systemctl restart agentiq-celery
            sudo systemctl restart agentiq-celery-beat

            # Rollback frontend
            if [ -d "/var/www/agentiq.backup" ]; then
              sudo rm -rf /var/www/agentiq/*
              sudo cp -r /var/www/agentiq.backup/* /var/www/agentiq/
              sudo chown -R www-data:www-data /var/www/agentiq
            fi

            echo "‚úÖ Rollback completed"

            # Verify rollback
            sleep 10
            curl -f https://agentiq.ru/api/health || echo "‚ö†Ô∏è Health check still failing after rollback"

      - name: Notify on failure
        if: steps.smoke_test.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const message = `‚ùå **Production Deploy Failed**

            Deployment failed and has been **rolled back** to the previous version.

            **Deployed by:** @${context.actor}
            **Workflow:** [View logs](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

            **Action Required:**
            1. Check workflow logs for error details
            2. Fix issues on staging first
            3. Re-run QA checklist
            4. Try deploying again

            Production is now running the previous stable version.`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `‚ö†Ô∏è Production Deploy Failed - ${new Date().toISOString().split('T')[0]}`,
              body: message,
              labels: ['deployment', 'production', 'failed']
            });
