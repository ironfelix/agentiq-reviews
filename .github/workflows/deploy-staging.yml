name: Deploy to Staging

on:
  push:
    branches:
      - main

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd apps/chat-center/backend
          pip install -r requirements.txt

      - name: Run unit tests
        run: |
          cd apps/chat-center/backend
          pytest tests/ -v --tb=short
        env:
          # Required by pydantic Settings ‚Äî test values, not production secrets
          ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY || '7JiOr8WP3UdiuX6DDkxsbwdiFNXyYoKxYc_CIci5qJo=' }}
          SECRET_KEY: "ci-test-secret-key-not-for-production"
          DATABASE_URL: "sqlite+aiosqlite:///:memory:"
          REDIS_URL: "redis://localhost:6379/0"

  deploy:
    name: Deploy to Staging
    needs: test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Generate CHANGELOG.html
        run: python scripts/generate-changelog.py
        continue-on-error: true

      - name: Copy backend to staging VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: 79.137.175.164
          username: ubuntu
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "apps/chat-center/backend/"
          target: "/tmp/agentiq-staging-deploy"
          strip_components: 0

      - name: Deploy backend to staging
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 79.137.175.164
          username: ubuntu
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "üöÄ Deploying backend to staging..."

            STAGING_BACKEND="/opt/agentiq-staging/app/apps/chat-center/backend"

            sudo rsync -a --delete \
              --exclude="*.pyc" \
              --exclude=".DS_Store" \
              --exclude="__pycache__" \
              --exclude="venv" \
              /tmp/agentiq-staging-deploy/apps/chat-center/backend/ \
              $STAGING_BACKEND/

            rm -rf /tmp/agentiq-staging-deploy

            # Install deps
            sudo /opt/agentiq-staging/venv/bin/pip install \
              -r $STAGING_BACKEND/requirements.txt -q

            # Run migrations
            cd $STAGING_BACKEND && \
              sudo /opt/agentiq-staging/venv/bin/alembic upgrade head 2>/dev/null || true

            # Restart services
            sudo systemctl restart agentiq-staging-chat 2>/dev/null || \
              sudo systemctl restart agentiq-staging 2>/dev/null || true
            sudo systemctl restart agentiq-staging-celery 2>/dev/null || true

            echo "‚úÖ Backend deployed to staging"

      - name: Sync docs to staging /docs/
        uses: appleboy/scp-action@v0.1.7
        with:
          host: 79.137.175.164
          username: ubuntu
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "docs/"
          target: "/tmp/agentiq-staging-docs"
          strip_components: 0

      - name: Install staging docs
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 79.137.175.164
          username: ubuntu
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            sudo rsync -a --delete \
              --exclude="*.pyc" --exclude=".DS_Store" \
              /tmp/agentiq-staging-docs/docs/ \
              /var/www/agentiq/docs/
            sudo chown -R www-data:www-data /var/www/agentiq/docs/
            rm -rf /tmp/agentiq-staging-docs
            echo "‚úÖ Docs synced"

      - name: Wait for services to start
        run: sleep 10

      - name: Smoke test backend
        run: |
          echo "üß™ Running smoke tests..."
          HEALTH=$(curl -s -o /dev/null -w "%{http_code}" \
            http://79.137.175.164/staging/api/health 2>/dev/null || \
            curl -s -o /dev/null -w "%{http_code}" \
            https://agentiq.ru/api/health)

          if [ "$HEALTH" = "200" ]; then
            echo "‚úÖ Health check passed ($HEALTH)"
          else
            echo "‚ö†Ô∏è Health check: HTTP $HEALTH (non-blocking)"
          fi
        continue-on-error: true
