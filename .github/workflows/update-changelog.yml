name: Update Changelog & Sync Docs

on:
  push:
    branches: [main]

jobs:
  sync-docs:
    name: Generate Changelog & Sync docs/ to VPS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # –ø–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è git log

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Generate CHANGELOG.html
        run: python scripts/generate-changelog.py

      - name: Copy docs/ to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: 79.137.175.164
          username: ubuntu
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "docs/"
          target: "/tmp/agentiq-docs-deploy"
          strip_components: 0

      - name: Install to web root
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 79.137.175.164
          username: ubuntu
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "üîÑ Syncing docs/ ‚Üí /var/www/agentiq/docs/ ..."
            sudo rsync -a --delete \
              --exclude="*.pyc" \
              --exclude=".DS_Store" \
              /tmp/agentiq-docs-deploy/docs/ \
              /var/www/agentiq/docs/

            # –î—É–±–ª—å –≤ –∫–æ—Ä–Ω–µ –¥–ª—è /docs-home.html –±–µ–∑ /docs/
            sudo cp /var/www/agentiq/docs/docs-home.html \
                    /var/www/agentiq/docs-home.html

            sudo chown -R www-data:www-data \
              /var/www/agentiq/docs/ \
              /var/www/agentiq/docs-home.html

            # Cleanup
            rm -rf /tmp/agentiq-docs-deploy

            echo "‚úÖ $(ls /var/www/agentiq/docs/ | wc -l) —Ñ–∞–π–ª–æ–≤ –≤ /docs/"

      - name: Verify deployment
        run: |
          sleep 5
          for FILE in docs-home.html CHANGELOG.html; do
            CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              -u docs:docs "https://agentiq.ru/docs/$FILE")
            if [ "$CODE" != "200" ]; then
              echo "‚ùå /docs/$FILE ‚Äî HTTP $CODE"
              exit 1
            fi
            echo "‚úÖ /docs/$FILE ‚Äî $CODE"
          done
