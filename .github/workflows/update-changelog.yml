name: Update Changelog

on:
  push:
    branches: [main]

jobs:
  changelog:
    name: Generate & Deploy Changelog
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # –Ω—É–∂–Ω–∞ –ø–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è git log

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Generate CHANGELOG.html
        run: python scripts/generate-changelog.py --since 2026-01-01

      - name: Deploy CHANGELOG.html to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 79.137.175.164
          username: ubuntu
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "üìÑ Pulling latest docs from repo..."
            cd /opt/agentiq && git pull origin main --quiet

            echo "üìã Generating CHANGELOG.html on VPS..."
            python3 /opt/agentiq/scripts/generate-changelog.py

            echo "üöÄ Deploying to /docs/..."
            sudo cp /opt/agentiq/docs/CHANGELOG.html /var/www/agentiq/docs/CHANGELOG.html
            sudo cp /opt/agentiq/docs/docs-home.html  /var/www/agentiq/docs/docs-home.html
            sudo cp /opt/agentiq/docs/docs-home.html  /var/www/agentiq/docs-home.html
            sudo chown www-data:www-data \
              /var/www/agentiq/docs/CHANGELOG.html \
              /var/www/agentiq/docs/docs-home.html \
              /var/www/agentiq/docs-home.html

            echo "‚úÖ Docs live at https://agentiq.ru/docs/"

      - name: Verify deployment
        run: |
          sleep 5
          CODE=$(curl -s -o /dev/null -w "%{http_code}" -u docs:docs https://agentiq.ru/docs/CHANGELOG.html)
          if [ "$CODE" != "200" ]; then
            echo "‚ùå /docs/CHANGELOG.html not reachable (HTTP $CODE)"
            exit 1
          fi
          echo "‚úÖ https://agentiq.ru/docs/CHANGELOG.html ‚Äî HTTP $CODE"
