# AgentIQ — Инструкции для Claude Code

## Обязательно читай перед работой

При работе с communication analysis (comm-*.html) и ответами на отзывы:
1. **`docs/RESPONSE_GUARDRAILS.md`** — правила генерации ответов, banned phrases, формат
2. **`scripts/llm_analyzer.py`** строки 608-699 — COMM_SYSTEM промпт и формат JSON
3. **`scripts/llm_analyzer.py`** строки 478-519 — GUARDRAILS конфиг (banned phrases, лимиты)

При работе с анализом отзывов (карточки, reasoning):
1. **`docs/reasoning-rules.md`** — классификация, пороги, примеры рассуждений
2. **`docs/CARD_FORMAT.md`** — формат карточек

## Критические правила (всегда)

### Ответы на отзывы (recommendation в "Как стоило ответить")
- Пиши **готовый текст ответа от лица продавца** в кавычках
- НЕ пиши инструкции/размышления ("Стоило извиниться и объяснить...")
- Правильно: `«Благодарим за отзыв! Нам жаль, что время работы не оправдало ожиданий...»`
- Неправильно: `«Стоило извиниться за недопонимание и вежливо объяснить...»`

### Banned phrases (НИКОГДА не писать в ответах)
- "вернём деньги", "гарантируем возврат/замену", "полный возврат", "бесплатную замену"
- "вы неправильно", "вы не так", "ваша вина", "сами виноваты"
- "обратитесь в поддержку" (= отписка)
- "ИИ", "бот", "нейросеть", "GPT", "ChatGPT", "автоматический ответ"

### Возврат/замена — только если покупатель сам попросил
- Триггеры: "возврат", "вернуть", "замена", "заменить", "обменять"
- Если триггер есть → "Оформите возврат через ЛК WB как «не соответствует описанию»"
- Если триггера нет → эмпатия + объяснение + помощь, БЕЗ упоминания возврата

## WB API

### CDN (без авторизации)
Base: `https://basket-{N}.wbbasket.ru/vol{V}/part{P}/{nmId}/info/`
- `…/ru/card.json` — характеристики, описание, состав, цвета
- `…/price-history.json` — история цен в копейках (÷100 = рубли), ~12 недель
- Basket N вычисляется из `nmId // 100000` (см. `_wb_basket_num()`)
- Gzip-ответы — обрабатывать `Content-Encoding: gzip`

### WBCON Feedbacks API
- Base: `https://19-fb.wbcon.su/`
- Auth: JWT token в заголовке `token`
- `POST /create_task_fb` (body: `{"article": int}`)
- `GET /task_status?task_id=X`
- `GET /get_results_fb?task_id=X`
- Пагинация сломана: заявляет N, отдаёт меньше

## Структура comm-*.html (шаблон)

Порядок секций (см. `communication-loss-282955222.html` как эталон):
1. **Качество ответов** — verdict, gauge, stats (4 категории на ВСЕ отзывы), loss-box с ₽/мес
2. **Скорость ответа** — медиана/среднее для негатива и всех
3. **Качество ответов (breakdown)** — горизонтальные бары: хорошие, нормальные, ошибки
4. **[Fashion]** Размер, ткань, цвет — таблица с тегами
5. **ТОП-3 худших** — цитата отзыва + цитата ответа + тег + expandable "Как стоило ответить"
6. **Что видит покупатель** — perception list
7. **Скрытые проблемы в позитиве** — 4-5★ с жалобами + expandable подробный разбор
8. **Что делать** — "Почему важно" + numbered action list
